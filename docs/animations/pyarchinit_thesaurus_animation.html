<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PyArchInit — Thesaurus Tutorial</title>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{--bg:#0d1117;--bg2:#161b22;--bg3:#21262d;--bg4:#30363d;--text:#e6edf3;--muted:#8b949e;--accent:#58a6ff;--green:#3fb950;--red:#f85149;--orange:#d29922;--purple:#bc8cff;--cyan:#39d353;--radius:8px}
html{font-size:14px}body{font-family:'Segoe UI',-apple-system,BlinkMacSystemFont,sans-serif;background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden}
.app{display:grid;grid-template-columns:1fr 250px;grid-template-rows:auto 1fr auto;height:100vh}
.hdr{grid-column:1/-1;background:var(--bg2);border-bottom:1px solid var(--bg4);padding:12px 20px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px}
.hdr h1{font-size:1.2rem;font-weight:600;color:var(--accent)}.hdr h1 span{color:var(--muted);font-weight:400}
.main{grid-column:1;display:flex;flex-direction:column;overflow:hidden}
.side{grid-column:2;grid-row:2/4;background:var(--bg2);border-left:1px solid var(--bg4);padding:14px;overflow-y:auto;display:flex;flex-direction:column;gap:12px}
.log{grid-column:1;background:var(--bg2);border-top:1px solid var(--bg4);padding:10px 20px;max-height:160px;overflow-y:auto}
.ctrls{display:flex;align-items:center;gap:5px;flex-wrap:wrap}
.ctrls button,.ctrls select{background:var(--bg3);border:1px solid var(--bg4);color:var(--text);padding:5px 10px;border-radius:var(--radius);cursor:pointer;font-size:.82rem;transition:all .2s}
.ctrls button:hover{border-color:var(--accent);background:rgba(88,166,255,.1)}
.ctrls button.on{background:var(--accent);color:#000;border-color:var(--accent)}
.ctrls button:disabled{opacity:.3;cursor:default}
.g{display:flex;gap:1px}.g button{border-radius:0}.g button:first-child{border-radius:var(--radius) 0 0 var(--radius)}.g button:last-child{border-radius:0 var(--radius) var(--radius) 0}
.scene{flex:1;position:relative;overflow:hidden;min-height:200px}.scene canvas{width:100%;height:100%;display:block}
.dsc{position:absolute;top:10px;left:10px;background:rgba(13,17,23,.92);backdrop-filter:blur(6px);border:1px solid var(--bg4);border-radius:var(--radius);padding:10px 14px;max-width:380px;font-size:.83rem;line-height:1.5;z-index:5}.dsc strong{color:var(--accent)}
.dots{position:absolute;bottom:10px;left:50%;transform:translateX(-50%);display:flex;gap:5px;z-index:5}
.dot{width:8px;height:8px;border-radius:50%;background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.15);transition:all .3s}
.dot.on{background:var(--accent);border-color:var(--accent);box-shadow:0 0 6px var(--accent)}.dot.ok{background:var(--green);border-color:var(--green)}
.w{background:var(--bg3);border-radius:var(--radius);padding:12px;border:1px solid rgba(88,166,255,.06)}
.w h3{font-size:.68rem;text-transform:uppercase;letter-spacing:1px;color:var(--muted);margin-bottom:7px}
.sr{display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid rgba(255,255,255,.03);font-size:.82rem}.sr:last-child{border:none}
.sl{color:var(--muted)}.sv{font-weight:600;font-variant-numeric:tabular-nums}
.cat-list{display:flex;flex-direction:column;gap:3px}
.cat{display:flex;align-items:center;gap:6px;padding:3px 6px;border-radius:4px;font-size:.78rem;transition:all .3s}
.cat.hl{background:rgba(88,166,255,.1);border:1px solid var(--accent)}
.cat-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.log h3{font-size:.68rem;text-transform:uppercase;letter-spacing:1px;color:var(--muted);margin-bottom:5px}
.les{display:flex;flex-direction:column;gap:2px}
.le{display:flex;gap:6px;font-size:.8rem;padding:2px 5px;border-radius:3px;animation:fi .3s}
@keyframes fi{from{opacity:0;transform:translateY(-3px)}to{opacity:1}}
.le.info{background:rgba(88,166,255,.04)}.le.success{background:rgba(63,185,80,.06)}.le.warn{background:rgba(210,153,34,.06)}.le.error{background:rgba(248,81,73,.06)}
.le-t{color:var(--muted);min-width:40px;flex-shrink:0;font-variant-numeric:tabular-nums}.le-i{flex-shrink:0;width:14px;text-align:center}.le-x{flex:1}
@media(max-width:860px){.app{grid-template-columns:1fr;grid-template-rows:auto 1fr auto auto}.side{grid-column:1;grid-row:4;flex-direction:row;flex-wrap:wrap;border-left:none;border-top:1px solid var(--bg4)}.w{flex:1;min-width:160px}}
::-webkit-scrollbar{width:5px}::-webkit-scrollbar-track{background:var(--bg)}::-webkit-scrollbar-thumb{background:var(--bg3);border-radius:3px}
</style>
</head>
<body>
<div class="app">
  <div class="hdr">
    <h1>Thesaurus Manager <span>— Controlled Vocabularies &amp; Standardized Data Entry</span></h1>
    <div class="ctrls">
      <select id="sel"><option value="0">1. Vocabulary Structure</option><option value="1">2. Adding / Editing Terms</option><option value="2">3. Multi-language Support</option><option value="3">4. Integration with Data Entry</option></select>
      <div class="g"><button id="bA" class="on">&#9654; Auto</button><button id="bM">&#9998; Manual</button></div>
      <div class="g"><button class="sp on" data-s="1">1x</button><button class="sp" data-s="2">2x</button><button class="sp" data-s="4">4x</button></div>
      <button id="bPP">&#10074;&#10074;</button><button id="bPr" disabled>&larr;</button><button id="bNx" disabled>&rarr;</button><button id="bRe">&#8634;</button>
      <button id="bL">&#8635; Loop</button><button id="bSt" style="display:none">&#9632; Stop</button>
    </div>
  </div>
  <div class="main"><div class="scene"><canvas id="cv"></canvas><div class="dsc" id="dsc"></div><div class="dots" id="dots"></div></div></div>
  <div class="side">
    <div class="w"><h3>Thesaurus Categories</h3>
      <div class="cat-list" id="catList">
        <div class="cat" data-c="def_strat"><span class="cat-dot" style="background:#58a6ff"></span>Definizione stratigrafica</div>
        <div class="cat" data-c="tipo_mat"><span class="cat-dot" style="background:#f85149"></span>Tipo materiale</div>
        <div class="cat" data-c="colore"><span class="cat-dot" style="background:#d29922"></span>Colore</div>
        <div class="cat" data-c="consist"><span class="cat-dot" style="background:#bc8cff"></span>Consistenza</div>
        <div class="cat" data-c="composiz"><span class="cat-dot" style="background:#3fb950"></span>Composizione</div>
        <div class="cat" data-c="forma"><span class="cat-dot" style="background:#39d353"></span>Forma</div>
        <div class="cat" data-c="tecnica"><span class="cat-dot" style="background:#8b949e"></span>Tecnica</div>
      </div>
    </div>
    <div class="w"><h3>Term Stats</h3>
      <div class="sr"><span class="sl">Categories</span><span class="sv" id="sCat">0</span></div>
      <div class="sr"><span class="sl">Total Terms</span><span class="sv" id="sTerms">0</span></div>
      <div class="sr"><span class="sl">In Use</span><span class="sv" id="sUsed">0</span></div>
    </div>
    <div class="w"><h3>Current Language</h3>
      <div class="sr"><span class="sl">Active</span><span class="sv" id="sLang">it</span></div>
      <div class="sr"><span class="sl">Fallback</span><span class="sv" id="sFall">it</span></div>
    </div>
  </div>
  <div class="log"><h3>Event Log</h3><div class="les" id="logE"></div></div>
</div>
<script>
(function(){
'use strict';
const $=id=>document.getElementById(id),cv=$('cv'),ctx=cv.getContext('2d');
const A={sc:0,mode:'auto',speed:1,playing:true,step:0,steps:[],timer:null,looping:false,logN:0,hlCat:null,hlLang:null,animT:0};
const sel=$('sel'),bA=$('bA'),bM=$('bM'),bPP=$('bPP'),bPr=$('bPr'),bNx=$('bNx'),bRe=$('bRe'),bL=$('bL'),bSt=$('bSt'),logE=$('logE'),dsc=$('dsc'),dots=$('dots'),spB=document.querySelectorAll('.sp');

const CAT_COLORS={def_strat:'#58a6ff',tipo_mat:'#f85149',colore:'#d29922',consist:'#bc8cff',composiz:'#3fb950',forma:'#39d353',tecnica:'#8b949e'};

const SC=[
  {title:'Vocabulary Structure',desc:'<strong>Structure:</strong> The Thesaurus organizes controlled vocabularies hierarchically for standardized archaeological data entry.',
   steps:[
    {log:'Thesaurus organizes terms in a hierarchy: Category > Subcategory > Terms.',type:'info',cat:'def_strat',stats:{cat:7},d:'The pyarchinit_thesaurus_sigle table stores codes and abbreviations used to populate dropdown menus across all forms.'},
    {log:'Table: pyarchinit_thesaurus_sigle stores (sigla, sigla_estesa, tipologia_sigla, lingua).',type:'info',d:'Each record has a code (sigla), its expanded form (sigla_estesa), a category type (tipologia_sigla), and language (lingua).'},
    {log:'Category: "Definizione stratigrafica" — types of stratigraphic units (strato, muro, taglio, riempimento...).',type:'info',cat:'def_strat',stats:{terms:24},d:'This category feeds the US form dropdowns. Example terms: strato (layer), muro (wall), taglio (cut), riempimento (fill).'},
    {log:'Category: "Tipo materiale" — ceramic, metal, glass, bone, lithic, organic materials.',type:'info',cat:'tipo_mat',stats:{terms:42},d:'Material type codes are used in the Finds Inventory (Inventario Materiali) form to classify artifacts.'},
    {log:'Category: "Colore" — standardized color descriptions following Munsell or descriptive systems.',type:'info',cat:'colore',stats:{terms:58},d:'Color terms ensure consistent soil and material descriptions: bruno, giallastro, rossastro, grigio, nero, etc.'},
  ]},
  {title:'Adding / Editing Terms',desc:'<strong>Management:</strong> Add, edit, and delete terms through the Thesaurus Manager dialog.',
   steps:[
    {log:'Open Thesaurus Manager: pyarchinit_Thesaurus class provides the management UI.',type:'info',d:'Access via Plugin menu > PyArchInit > Gestione Thesaurus, or from the toolbar.'},
    {log:'Select category "Definizione stratigrafica" — 24 existing terms loaded.',type:'info',cat:'def_strat',stats:{cat:7,terms:24},d:'The category dropdown filters the term list. Selecting a category queries pyarchinit_thesaurus_sigle WHERE tipologia_sigla = selected.'},
    {log:'View existing terms: strato, muro, taglio, riempimento, pavimento, focolare...',type:'info',d:'Terms are displayed in a sortable table with columns: Code, Description, Language.'},
    {log:'Add new term: sigla="battuto", sigla_estesa="Battuto pavimentale", lingua="it".',type:'info',stats:{terms:25},d:'Click "Aggiungi" (Add). Fill in code, full description, and language. INSERT INTO pyarchinit_thesaurus_sigle.'},
    {log:'Edit term: "muro" description updated to "Muro / Struttura muraria".',type:'warn',d:'Select a term and click "Modifica" (Edit). UPDATE pyarchinit_thesaurus_sigle SET sigla_estesa = new_value.'},
    {log:'Delete validation: checking if "focolare" is referenced in 3 US records...',type:'warn',stats:{used:3},d:'Before deletion, the system queries us_table to check if the term is in use. If referenced, a warning is shown.'},
  ]},
  {title:'Multi-language Support',desc:'<strong>i18n:</strong> Terms are available in multiple languages, auto-detected from QGIS locale.',
   steps:[
    {log:'Supported languages: it (Italian), en (English), de (German), fr (French), es (Spanish), ar (Arabic), ca (Catalan).',type:'info',d:'The lingua column in pyarchinit_thesaurus_sigle stores the ISO language code for each term.'},
    {log:'Language auto-detected from QGIS locale: QSettings().value("locale/userLocale").',type:'info',lang:'en',stats:{cat:7,terms:42},d:'On startup, PyArchInit reads the QGIS locale setting and filters thesaurus queries by the matching language code.'},
    {log:'Fallback logic: if no translation found for current locale, Italian (it) is used.',type:'warn',lang:'it',d:'Italian is the default/fallback language since PyArchInit originated in Italy. Missing translations gracefully degrade.'},
    {log:'Example: "strato" (it) = "layer" (en) = "Schicht" (de) = "couche" (fr) = "estrato" (es).',type:'info',d:'Each term can have parallel entries in multiple languages, all sharing the same tipologia_sigla category.'},
    {log:'Multi-language query: SELECT * FROM pyarchinit_thesaurus_sigle WHERE tipologia_sigla=? AND lingua=?.',type:'success',d:'The dual filter (category + language) ensures users see terms in their preferred language across all form dropdowns.'},
  ]},
  {title:'Integration with Data Entry',desc:'<strong>Integration:</strong> Thesaurus terms feed dropdown menus and auto-complete fields across all archaeological forms.',
   steps:[
    {log:'Thesaurus feeds QComboBox dropdowns in all major forms: US, Finds, Pottery, Tomba, etc.',type:'info',cat:'def_strat',d:'Each form controller queries the thesaurus at load time to populate its dropdown menus with standardized terms.'},
    {log:'US form: "Definizione stratigrafica" dropdown populated from thesaurus query.',type:'info',cat:'def_strat',stats:{cat:7,terms:24},d:'In tabs/pyarchinit_US_mainapp.py, the combo box calls charge_list() which fetches terms from the thesaurus table.'},
    {log:'Finds form: "Tipo materiale" dropdown loaded — ceramica, metallo, vetro, osso, litica...',type:'info',cat:'tipo_mat',stats:{terms:42},d:'The Inventario Materiali form uses the same pattern: query thesaurus, populate QComboBox, enable auto-complete.'},
    {log:'Auto-complete enabled: QCompleter attached to QComboBox for fast text matching.',type:'info',d:'As the user types, matching thesaurus terms are suggested. This speeds data entry and prevents typos.'},
    {log:'Standardization: all users on the same project share the same controlled vocabulary.',type:'success',stats:{used:156},d:'Because all forms pull from the same thesaurus, data consistency is guaranteed across team members and sessions.'},
    {log:'Custom vocabularies: site-specific terms can be added without modifying core thesaurus.',type:'success',d:'Project managers can extend the thesaurus with site-specific terms while keeping the base vocabulary intact.'},
  ]}
];

function hlCat(c){A.hlCat=c;document.querySelectorAll('.cat').forEach(el=>el.classList.toggle('hl',el.dataset.c===c));}
function updStats(o){if(o){if(o.cat!==undefined)$('sCat').textContent=o.cat;if(o.terms!==undefined)$('sTerms').textContent=o.terms;if(o.used!==undefined)$('sUsed').textContent=o.used;}}
function updLang(l){if(l){A.hlLang=l;$('sLang').textContent=l;}}
function addLog(t,type){A.logN++;const now=new Date(),ts=String(now.getMinutes()).padStart(2,'0')+':'+String(now.getSeconds()).padStart(2,'0');const ic={info:'&#8505;',success:'&#10004;',warn:'&#9888;',error:'&#10008;'};const cl={info:'#58a6ff',success:'#3fb950',warn:'#d29922',error:'#f85149'};const d=document.createElement('div');d.className='le '+type;d.innerHTML='<span class="le-t">'+ts+'</span><span class="le-i" style="color:'+cl[type]+'">'+ic[type]+'</span><span class="le-x">'+t+'</span>';logE.prepend(d);while(logE.children.length>25)logE.removeChild(logE.lastChild);}
function updDots(){dots.innerHTML='';A.steps.forEach(function(_,i){const d=document.createElement('div');d.className='dot'+(i===A.step?' on':i<A.step?' ok':'');dots.appendChild(d);});}
function updDesc(h){dsc.innerHTML=h||'';dsc.style.opacity=h?'1':'0';}
function resize(){const r=cv.parentElement.getBoundingClientRect(),dpr=window.devicePixelRatio||1;cv.width=r.width*dpr;cv.height=r.height*dpr;cv.style.width=r.width+'px';cv.style.height=r.height+'px';ctx.setTransform(dpr,0,0,dpr,0,0);}
window.addEventListener('resize',resize);
function rr(x,y,w,h,r){ctx.beginPath();ctx.moveTo(x+r,y);ctx.lineTo(x+w-r,y);ctx.quadraticCurveTo(x+w,y,x+w,y+r);ctx.lineTo(x+w,y+h-r);ctx.quadraticCurveTo(x+w,y+h,x+w-r,y+h);ctx.lineTo(x+r,y+h);ctx.quadraticCurveTo(x,y+h,x,y+h-r);ctx.lineTo(x,y+r);ctx.quadraticCurveTo(x,y,x+r,y);ctx.closePath();}

/* SVG-style icon helpers drawn with canvas paths */
function drawBookIcon(cx,cy,s){
  ctx.save();ctx.translate(cx,cy);ctx.scale(s,s);
  ctx.beginPath();ctx.moveTo(-6,-7);ctx.lineTo(-6,7);ctx.lineTo(6,7);ctx.lineTo(6,-7);ctx.lineTo(0,-4);ctx.lineTo(-6,-7);ctx.closePath();
  ctx.strokeStyle='#58a6ff';ctx.lineWidth=1.2;ctx.stroke();
  ctx.beginPath();ctx.moveTo(0,-4);ctx.lineTo(0,7);ctx.stroke();
  ctx.restore();
}
function drawPlusIcon(cx,cy,s,color){
  ctx.save();ctx.translate(cx,cy);ctx.scale(s,s);
  ctx.strokeStyle=color||'#3fb950';ctx.lineWidth=1.5;
  ctx.beginPath();ctx.moveTo(-5,0);ctx.lineTo(5,0);ctx.stroke();
  ctx.beginPath();ctx.moveTo(0,-5);ctx.lineTo(0,5);ctx.stroke();
  ctx.restore();
}
function drawGlobeIcon(cx,cy,s){
  ctx.save();ctx.translate(cx,cy);ctx.scale(s,s);
  ctx.strokeStyle='#bc8cff';ctx.lineWidth=1;
  ctx.beginPath();ctx.arc(0,0,7,0,Math.PI*2);ctx.stroke();
  ctx.beginPath();ctx.ellipse(0,0,3,7,0,0,Math.PI*2);ctx.stroke();
  ctx.beginPath();ctx.moveTo(-7,0);ctx.lineTo(7,0);ctx.stroke();
  ctx.restore();
}
function drawDropdownIcon(cx,cy,s,color){
  ctx.save();ctx.translate(cx,cy);ctx.scale(s,s);
  ctx.strokeStyle=color||'#d29922';ctx.lineWidth=1.2;
  rr(-8,-5,16,10,2);ctx.stroke();
  ctx.beginPath();ctx.moveTo(3,-2);ctx.lineTo(6,2);ctx.lineTo(9,-2);ctx.stroke();
  ctx.restore();
}

function drawScene0(W,H,t){
  /* Vocabulary Structure — tree diagram */
  var cx=W*0.5,cy=H*0.12;
  /* Root node: THESAURUS */
  rr(cx-50,cy-12,100,24,5);ctx.fillStyle='#161b22';ctx.fill();ctx.strokeStyle='#58a6ff';ctx.lineWidth=1.5;ctx.stroke();
  drawBookIcon(cx-32,cy,0.8);
  ctx.fillStyle='#58a6ff';ctx.font='bold 10px sans-serif';ctx.textAlign='center';ctx.fillText('THESAURUS',cx+6,cy+4);

  /* Category nodes */
  var cats=[
    {label:'Def. stratigrafica',color:'#58a6ff',x:0.15,y:0.30},
    {label:'Tipo materiale',color:'#f85149',x:0.40,y:0.30},
    {label:'Colore',color:'#d29922',x:0.62,y:0.30},
    {label:'Consistenza',color:'#bc8cff',x:0.85,y:0.30}
  ];
  cats.forEach(function(c){
    var nx=W*c.x,ny=H*c.y;
    /* connector line */
    ctx.strokeStyle=c.color+'44';ctx.lineWidth=1;ctx.setLineDash([3,3]);
    ctx.beginPath();ctx.moveTo(cx,cy+12);ctx.lineTo(nx,ny-12);ctx.stroke();
    ctx.setLineDash([]);
    /* node */
    var hl=A.hlCat&&(c.label.toLowerCase().indexOf(A.hlCat.substring(0,3))>=0);
    rr(nx-55,ny-12,110,24,4);ctx.fillStyle=hl?c.color+'22':'#161b22';ctx.fill();
    ctx.strokeStyle=hl?c.color:c.color+'66';ctx.lineWidth=hl?1.5:1;ctx.stroke();
    ctx.fillStyle=hl?'#e6edf3':'#8b949e';ctx.font=(hl?'bold ':'')+'8px sans-serif';ctx.textAlign='center';
    ctx.fillText(c.label,nx,ny+3);
  });

  /* Sub-terms under Def. stratigrafica */
  var terms1=['strato','muro','taglio','riempimento','pavimento'];
  var bx=W*0.15,by=H*0.30+20;
  terms1.forEach(function(tm,i){
    var ty=by+i*20;
    if(ty+14>H*0.92)return;
    ctx.strokeStyle='#58a6ff22';ctx.lineWidth=1;ctx.setLineDash([2,2]);
    ctx.beginPath();ctx.moveTo(bx,by-6);ctx.lineTo(bx-20,ty+5);ctx.stroke();ctx.setLineDash([]);
    rr(bx-50,ty-4,60,14,3);
    var termHl=A.hlCat==='def_strat'&&A.step>=2;
    ctx.fillStyle=termHl?'#58a6ff11':'#0d111799';ctx.fill();
    ctx.strokeStyle=termHl?'#58a6ff55':'#30363d';ctx.lineWidth=0.8;ctx.stroke();
    ctx.fillStyle=termHl?'#e6edf3':'#8b949e';ctx.font='7px sans-serif';ctx.textAlign='center';ctx.fillText(tm,bx-20,ty+5);
  });

  /* Sub-terms under Tipo materiale */
  var terms2=['ceramica','metallo','vetro','osso','litica','organico'];
  var bx2=W*0.40,by2=H*0.30+20;
  terms2.forEach(function(tm,i){
    var ty=by2+i*20;
    if(ty+14>H*0.92)return;
    ctx.strokeStyle='#f8514922';ctx.lineWidth=1;ctx.setLineDash([2,2]);
    ctx.beginPath();ctx.moveTo(bx2,by2-6);ctx.lineTo(bx2-20,ty+5);ctx.stroke();ctx.setLineDash([]);
    rr(bx2-50,ty-4,60,14,3);
    var termHl=A.hlCat==='tipo_mat'&&A.step>=3;
    ctx.fillStyle=termHl?'#f8514911':'#0d111799';ctx.fill();
    ctx.strokeStyle=termHl?'#f8514955':'#30363d';ctx.lineWidth=0.8;ctx.stroke();
    ctx.fillStyle=termHl?'#e6edf3':'#8b949e';ctx.font='7px sans-serif';ctx.textAlign='center';ctx.fillText(tm,bx2-20,ty+5);
  });

  /* Sub-terms under Colore */
  var terms3=['bruno','giallastro','rossastro','grigio','nero'];
  var bx3=W*0.62,by3=H*0.30+20;
  terms3.forEach(function(tm,i){
    var ty=by3+i*20;
    if(ty+14>H*0.92)return;
    ctx.strokeStyle='#d2992222';ctx.lineWidth=1;ctx.setLineDash([2,2]);
    ctx.beginPath();ctx.moveTo(bx3,by3-6);ctx.lineTo(bx3-20,ty+5);ctx.stroke();ctx.setLineDash([]);
    rr(bx3-50,ty-4,60,14,3);
    var termHl=A.hlCat==='colore'&&A.step>=4;
    ctx.fillStyle=termHl?'#d2992211':'#0d111799';ctx.fill();
    ctx.strokeStyle=termHl?'#d2992255':'#30363d';ctx.lineWidth=0.8;ctx.stroke();
    ctx.fillStyle=termHl?'#e6edf3':'#8b949e';ctx.font='7px sans-serif';ctx.textAlign='center';ctx.fillText(tm,bx3-20,ty+5);
  });

  /* DB table label */
  var dbx=W*0.85,dby=H*0.50;
  rr(dbx-60,dby-14,120,28,4);ctx.fillStyle='#21262d';ctx.fill();ctx.strokeStyle='#bc8cff55';ctx.lineWidth=1;ctx.stroke();
  ctx.fillStyle='#bc8cff';ctx.font='bold 8px sans-serif';ctx.textAlign='center';ctx.fillText('pyarchinit_thesaurus_sigle',dbx,dby+3);

  /* Columns */
  var cols=['sigla','sigla_estesa','tipologia_sigla','lingua'];
  cols.forEach(function(col,i){
    var cy2=dby+20+i*16;
    rr(dbx-50,cy2-5,100,13,2);ctx.fillStyle='#0d111799';ctx.fill();ctx.strokeStyle='#30363d';ctx.lineWidth=0.5;ctx.stroke();
    ctx.fillStyle='#8b949e';ctx.font='7px monospace';ctx.textAlign='center';ctx.fillText(col,dbx,cy2+5);
  });

  /* Animated pulse on active category */
  if(A.hlCat){
    var pulse=Math.sin(t*2)*0.3+0.7;
    var idx={def_strat:0,tipo_mat:1,colore:2,consist:3}[A.hlCat];
    if(idx!==undefined&&cats[idx]){
      var pc=cats[idx];
      ctx.strokeStyle=pc.color+Math.round(pulse*80).toString(16).padStart(2,'0');
      ctx.lineWidth=2;rr(W*pc.x-58,H*pc.y-15,116,30,6);ctx.stroke();
    }
  }
}

function drawScene1(W,H,t){
  /* Adding/Editing Terms — form with term list */
  var fx=W*0.04,fy=H*0.06,fw=W*0.44,fh=H*0.85;
  /* Dialog frame */
  rr(fx,fy,fw,fh,6);ctx.fillStyle='#161b22';ctx.fill();ctx.strokeStyle='#30363d';ctx.lineWidth=1;ctx.stroke();
  /* Title bar */
  rr(fx,fy,fw,22,6);ctx.fillStyle='#21262d';ctx.fill();ctx.strokeStyle='#30363d';ctx.lineWidth=0.5;ctx.stroke();
  ctx.fillStyle='#58a6ff';ctx.font='bold 9px sans-serif';ctx.textAlign='left';ctx.fillText('Thesaurus Manager — Gestione Thesaurus',fx+10,fy+14);
  /* Close button */
  ctx.strokeStyle='#f85149';ctx.lineWidth=1.2;
  ctx.beginPath();ctx.moveTo(fx+fw-14,fy+7);ctx.lineTo(fx+fw-7,fy+15);ctx.stroke();
  ctx.beginPath();ctx.moveTo(fx+fw-7,fy+7);ctx.lineTo(fx+fw-14,fy+15);ctx.stroke();

  /* Category dropdown */
  var dy=fy+32;
  ctx.fillStyle='#8b949e';ctx.font='8px sans-serif';ctx.textAlign='left';ctx.fillText('Categoria:',fx+8,dy+4);
  rr(fx+60,dy-6,fw-78,16,3);ctx.fillStyle='#0d1117';ctx.fill();ctx.strokeStyle='#58a6ff55';ctx.lineWidth=0.8;ctx.stroke();
  ctx.fillStyle='#e6edf3';ctx.font='8px sans-serif';ctx.fillText('Definizione stratigrafica',fx+66,dy+4);
  /* dropdown arrow */
  ctx.beginPath();ctx.moveTo(fx+fw-24,dy-1);ctx.lineTo(fx+fw-20,dy+3);ctx.lineTo(fx+fw-16,dy-1);ctx.strokeStyle='#58a6ff';ctx.lineWidth=1;ctx.stroke();

  /* Term list header */
  var ly=dy+18;
  ctx.fillStyle='#30363d';rr(fx+6,ly,fw-12,14,2);ctx.fill();
  ctx.fillStyle='#8b949e';ctx.font='bold 7px sans-serif';ctx.textAlign='left';
  ctx.fillText('Sigla',fx+12,ly+10);ctx.fillText('Descrizione',fx+80,ly+10);ctx.fillText('Lingua',fx+fw-48,ly+10);

  /* Terms */
  var terms=[
    {code:'strato',desc:'Strato / Layer',lang:'it'},
    {code:'muro',desc:'Muro / Struttura muraria',lang:'it'},
    {code:'taglio',desc:'Taglio / Cut',lang:'it'},
    {code:'riemp',desc:'Riempimento / Fill',lang:'it'},
    {code:'pavim',desc:'Pavimento / Floor',lang:'it'},
    {code:'focol',desc:'Focolare / Hearth',lang:'it'}
  ];
  var newTerm=A.step>=3;
  if(newTerm)terms.push({code:'battuto',desc:'Battuto pavimentale',lang:'it',isNew:true});
  var editTerm=A.step>=4;
  var delCheck=A.step>=5;

  terms.forEach(function(tm,i){
    var ry=ly+16+i*16;
    if(ry+14>fy+fh-30)return;
    var isEdit=editTerm&&tm.code==='muro';
    var isDel=delCheck&&tm.code==='focol';
    var isNew2=tm.isNew;
    rr(fx+6,ry,fw-12,14,2);
    if(isNew2){ctx.fillStyle='#3fb95011';ctx.fill();ctx.strokeStyle='#3fb95044';ctx.lineWidth=0.8;ctx.stroke();}
    else if(isEdit){ctx.fillStyle='#d2992211';ctx.fill();ctx.strokeStyle='#d2992244';ctx.lineWidth=0.8;ctx.stroke();}
    else if(isDel){ctx.fillStyle='#f8514911';ctx.fill();ctx.strokeStyle='#f8514944';ctx.lineWidth=0.8;ctx.stroke();}
    else{ctx.fillStyle='#0d111766';ctx.fill();}
    ctx.fillStyle=isNew2?'#3fb950':isEdit?'#d29922':isDel?'#f85149':'#e6edf3';
    ctx.font='7px monospace';ctx.textAlign='left';ctx.fillText(tm.code,fx+12,ry+10);
    ctx.fillStyle=isNew2?'#3fb950':isEdit?'#d29922':isDel?'#f85149':'#8b949e';
    ctx.font='7px sans-serif';ctx.fillText(isEdit?'Muro / Struttura muraria':tm.desc,fx+80,ry+10);
    ctx.fillStyle='#8b949e';ctx.fillText(tm.lang,fx+fw-44,ry+10);
  });

  /* Buttons at bottom */
  var btnY=fy+fh-24;
  var btns=[{label:'Aggiungi',color:'#3fb950',x:fx+8},{label:'Modifica',color:'#d29922',x:fx+70},{label:'Elimina',color:'#f85149',x:fx+132}];
  btns.forEach(function(b,i){
    var isActive=(i===0&&A.step===3)||(i===1&&A.step===4)||(i===2&&A.step===5);
    rr(b.x,btnY,56,18,3);ctx.fillStyle=isActive?b.color+'33':'#21262d';ctx.fill();
    ctx.strokeStyle=isActive?b.color:b.color+'44';ctx.lineWidth=isActive?1.5:0.8;ctx.stroke();
    ctx.fillStyle=isActive?'#e6edf3':'#8b949e';ctx.font=(isActive?'bold ':'')+'7px sans-serif';ctx.textAlign='center';ctx.fillText(b.label,b.x+28,btnY+12);
  });

  /* Right side — DB operation visualization */
  var rx=W*0.54,ry2=H*0.12;
  rr(rx,ry2,W*0.42,H*0.75,6);ctx.fillStyle='rgba(22,27,34,.6)';ctx.fill();ctx.strokeStyle='#30363d';ctx.lineWidth=1;ctx.stroke();
  ctx.fillStyle='#8b949e';ctx.font='bold 9px sans-serif';ctx.textAlign='left';ctx.fillText('Database Operations',rx+10,ry2+16);

  /* SQL statements */
  var sqls=[];
  if(A.step>=1)sqls.push({sql:'SELECT * FROM pyarchinit_thesaurus_sigle',color:'#58a6ff',label:'QUERY'});
  if(A.step>=2)sqls.push({sql:'WHERE tipologia_sigla = "def_strat"',color:'#58a6ff',label:'FILTER'});
  if(A.step>=3)sqls.push({sql:'INSERT INTO ... VALUES ("battuto", ...)',color:'#3fb950',label:'INSERT'});
  if(A.step>=4)sqls.push({sql:'UPDATE ... SET sigla_estesa = "Muro ..."',color:'#d29922',label:'UPDATE'});
  if(A.step>=5)sqls.push({sql:'SELECT COUNT(*) FROM us_table WHERE def_strat="focolare"',color:'#f85149',label:'CHECK'});

  sqls.forEach(function(s,i){
    var sy=ry2+30+i*28;
    rr(rx+8,sy,W*0.40,22,3);ctx.fillStyle='#0d111799';ctx.fill();ctx.strokeStyle=s.color+'44';ctx.lineWidth=0.8;ctx.stroke();
    /* label badge */
    rr(rx+12,sy+3,36,14,2);ctx.fillStyle=s.color+'22';ctx.fill();
    ctx.fillStyle=s.color;ctx.font='bold 7px sans-serif';ctx.textAlign='center';ctx.fillText(s.label,rx+30,sy+13);
    /* sql text */
    ctx.fillStyle='#8b949e';ctx.font='7px monospace';ctx.textAlign='left';ctx.fillText(s.sql,rx+54,sy+13);
  });

  /* Validation indicator */
  if(A.step>=5){
    var vy=ry2+30+sqls.length*28+10;
    var pulse2=Math.sin(t*3)*0.4+0.6;
    rr(rx+8,vy,W*0.40,30,4);ctx.fillStyle='#f8514911';ctx.fill();ctx.strokeStyle='#f85149'+Math.round(pulse2*80).toString(16).padStart(2,'0');ctx.lineWidth=1.2;ctx.stroke();
    ctx.fillStyle='#f85149';ctx.font='bold 8px sans-serif';ctx.textAlign='center';ctx.fillText('WARNING: Term "focolare" in use by 3 records',rx+W*0.20+4,vy+12);
    ctx.fillStyle='#8b949e';ctx.font='7px sans-serif';ctx.fillText('Deletion requires confirmation or reassignment',rx+W*0.20+4,vy+23);
  }
}

function drawScene2(W,H,t){
  /* Multi-language Support — flags and translations */
  var cx=W*0.5;

  /* Language nodes in a semicircle */
  var langs=[
    {code:'it',label:'Italiano',color:'#3fb950',full:true},
    {code:'en',label:'English',color:'#58a6ff',full:true},
    {code:'de',label:'Deutsch',color:'#d29922',full:true},
    {code:'fr',label:'Francais',color:'#bc8cff',full:true},
    {code:'es',label:'Espanol',color:'#f85149',full:true},
    {code:'ar',label:'Arabic',color:'#39d353',full:false},
    {code:'ca',label:'Catalan',color:'#8b949e',full:false}
  ];

  var gcx=W*0.28,gcy=H*0.5,gr=Math.min(W*0.22,H*0.35);
  /* Central globe icon */
  drawGlobeIcon(gcx,gcy,2.2);
  ctx.fillStyle='#bc8cff';ctx.font='bold 10px sans-serif';ctx.textAlign='center';ctx.fillText('LINGUA',gcx,gcy+22);

  langs.forEach(function(l,i){
    var angle=-Math.PI*0.75+i*(Math.PI*1.1/(langs.length-1));
    var lx=gcx+Math.cos(angle)*gr,ly=gcy+Math.sin(angle)*gr;
    var isHl=A.hlLang===l.code;
    /* Connector */
    ctx.strokeStyle=isHl?l.color+'88':l.color+'22';ctx.lineWidth=isHl?1.5:0.8;ctx.setLineDash([3,3]);
    ctx.beginPath();ctx.moveTo(gcx,gcy);ctx.lineTo(lx,ly);ctx.stroke();ctx.setLineDash([]);
    /* Node */
    rr(lx-28,ly-12,56,24,4);ctx.fillStyle=isHl?l.color+'22':'#161b22';ctx.fill();
    ctx.strokeStyle=isHl?l.color:l.color+'55';ctx.lineWidth=isHl?1.5:0.8;ctx.stroke();
    ctx.fillStyle=isHl?'#e6edf3':l.color;ctx.font='bold 9px sans-serif';ctx.textAlign='center';ctx.fillText(l.code.toUpperCase(),lx,ly-1);
    ctx.fillStyle='#8b949e';ctx.font='6px sans-serif';ctx.fillText(l.label,lx,ly+9);
    /* Fullness indicator */
    if(l.full){
      ctx.fillStyle='#3fb950';ctx.beginPath();ctx.arc(lx+22,ly-8,3,0,Math.PI*2);ctx.fill();
    }else{
      ctx.strokeStyle='#d29922';ctx.lineWidth=0.8;ctx.beginPath();ctx.arc(lx+22,ly-8,3,0,Math.PI*2);ctx.stroke();
    }
  });

  /* Translation example panel (right side) */
  var px=W*0.56,py=H*0.08,pw=W*0.40,ph=H*0.82;
  rr(px,py,pw,ph,6);ctx.fillStyle='rgba(22,27,34,.8)';ctx.fill();ctx.strokeStyle='#30363d';ctx.lineWidth=1;ctx.stroke();
  ctx.fillStyle='#58a6ff';ctx.font='bold 9px sans-serif';ctx.textAlign='left';ctx.fillText('Translation Table: "strato"',px+10,py+16);

  var translations=[
    {lang:'it',term:'strato',desc:'Strato / unita stratigrafica',color:'#3fb950'},
    {lang:'en',term:'layer',desc:'Layer / stratigraphic unit',color:'#58a6ff'},
    {lang:'de',term:'Schicht',desc:'Schicht / stratigraphische Einheit',color:'#d29922'},
    {lang:'fr',term:'couche',desc:'Couche / unite stratigraphique',color:'#bc8cff'},
    {lang:'es',term:'estrato',desc:'Estrato / unidad estratigrafica',color:'#f85149'},
    {lang:'ar',term:'tabaka',desc:'Tabaka (transliterated)',color:'#39d353'},
    {lang:'ca',term:'estrat',desc:'Estrat / unitat estratigrafica',color:'#8b949e'}
  ];

  translations.forEach(function(tr,i){
    var ry=py+26+i*24;
    if(ry+18>py+ph-10)return;
    var isHl=A.hlLang===tr.lang;
    rr(px+6,ry,pw-12,20,3);ctx.fillStyle=isHl?tr.color+'15':'#0d111766';ctx.fill();
    if(isHl){ctx.strokeStyle=tr.color+'55';ctx.lineWidth=0.8;ctx.stroke();}
    /* Lang badge */
    rr(px+10,ry+3,22,14,2);ctx.fillStyle=tr.color+'22';ctx.fill();ctx.strokeStyle=tr.color+'44';ctx.lineWidth=0.5;ctx.stroke();
    ctx.fillStyle=tr.color;ctx.font='bold 7px sans-serif';ctx.textAlign='center';ctx.fillText(tr.lang,px+21,ry+13);
    /* Term */
    ctx.fillStyle=isHl?'#e6edf3':'#e6edf3';ctx.font='bold 8px sans-serif';ctx.textAlign='left';ctx.fillText(tr.term,px+38,ry+13);
    /* Description */
    ctx.fillStyle='#8b949e';ctx.font='7px sans-serif';ctx.fillText(tr.desc,px+100,ry+13);
  });

  /* Fallback arrow */
  var fy=py+ph-30;
  rr(px+6,fy,pw-12,22,3);ctx.fillStyle='#d2992211';ctx.fill();ctx.strokeStyle='#d2992244';ctx.lineWidth=0.8;ctx.stroke();
  ctx.fillStyle='#d29922';ctx.font='bold 7px sans-serif';ctx.textAlign='center';ctx.fillText('FALLBACK: if lingua not found, use "it" (Italian)',px+pw/2,fy+14);

  /* Pulse on active language */
  if(A.hlLang){
    var pulse3=Math.sin(t*2.5)*0.3+0.7;
    var idx2=langs.findIndex(function(l){return l.code===A.hlLang;});
    if(idx2>=0){
      var angle2=-Math.PI*0.75+idx2*(Math.PI*1.1/(langs.length-1));
      var plx=gcx+Math.cos(angle2)*gr,ply=gcy+Math.sin(angle2)*gr;
      ctx.strokeStyle=langs[idx2].color+Math.round(pulse3*99).toString(16).padStart(2,'0');
      ctx.lineWidth=2;rr(plx-32,ply-16,64,32,6);ctx.stroke();
    }
  }
}

function drawScene3(W,H,t){
  /* Integration with Data Entry — form with populated dropdowns */

  /* Left: simplified US form */
  var fx=W*0.03,fy=H*0.06,fw=W*0.38,fh=H*0.85;
  rr(fx,fy,fw,fh,6);ctx.fillStyle='#161b22';ctx.fill();ctx.strokeStyle='#30363d';ctx.lineWidth=1;ctx.stroke();
  rr(fx,fy,fw,22,6);ctx.fillStyle='#21262d';ctx.fill();ctx.strokeStyle='#30363d';ctx.lineWidth=0.5;ctx.stroke();
  ctx.fillStyle='#58a6ff';ctx.font='bold 9px sans-serif';ctx.textAlign='left';ctx.fillText('US Form — Scheda US',fx+10,fy+14);

  /* Form fields */
  var fields=[
    {label:'Sito:',value:'Foro Romano',type:'text'},
    {label:'Area:',value:'A',type:'text'},
    {label:'US:',value:'101',type:'text'},
    {label:'Def. stratigrafica:',value:'strato',type:'dropdown',cat:'def_strat',color:'#58a6ff'},
    {label:'Def. interpretata:',value:'livello pavimentale',type:'dropdown',cat:'def_strat',color:'#58a6ff'},
    {label:'Colore:',value:'bruno',type:'dropdown',cat:'colore',color:'#d29922'},
    {label:'Consistenza:',value:'compatta',type:'dropdown',cat:'consist',color:'#bc8cff'},
    {label:'Composizione:',value:'argillosa',type:'dropdown',cat:'composiz',color:'#3fb950'}
  ];

  fields.forEach(function(f,i){
    var ry=fy+32+i*26;
    if(ry+18>fy+fh-10)return;
    ctx.fillStyle='#8b949e';ctx.font='8px sans-serif';ctx.textAlign='left';ctx.fillText(f.label,fx+8,ry+11);
    var inputX=fx+110,inputW=fw-118;
    rr(inputX,ry,inputW,16,3);
    var isHl=f.type==='dropdown'&&A.hlCat===f.cat;
    ctx.fillStyle=isHl?f.color+'11':'#0d1117';ctx.fill();
    ctx.strokeStyle=isHl?f.color+'66':'#30363d';ctx.lineWidth=isHl?1:0.6;ctx.stroke();
    ctx.fillStyle=isHl?'#e6edf3':'#8b949e';ctx.font='8px sans-serif';ctx.textAlign='left';ctx.fillText(f.value,inputX+6,ry+11);
    if(f.type==='dropdown'){
      /* dropdown arrow */
      ctx.beginPath();ctx.moveTo(inputX+inputW-12,ry+5);ctx.lineTo(inputX+inputW-8,ry+10);ctx.lineTo(inputX+inputW-4,ry+5);
      ctx.strokeStyle=f.color||'#8b949e';ctx.lineWidth=1;ctx.stroke();
    }
  });

  /* Center: thesaurus → dropdown flow arrows */
  var arrowX=W*0.43;
  /* Thesaurus DB icon */
  rr(arrowX-6,H*0.20,W*0.16,30,5);ctx.fillStyle='#21262d';ctx.fill();ctx.strokeStyle='#bc8cff55';ctx.lineWidth=1;ctx.stroke();
  drawBookIcon(arrowX+4,H*0.20+15,0.9);
  ctx.fillStyle='#bc8cff';ctx.font='bold 8px sans-serif';ctx.textAlign='left';ctx.fillText('THESAURUS',arrowX+16,H*0.20+18);

  /* Flow arrows to form */
  var arrowTargets=[
    {fromY:H*0.25,toY:fy+32+3*26+8,color:'#58a6ff',label:'def_strat'},
    {fromY:H*0.25,toY:fy+32+5*26+8,color:'#d29922',label:'colore'},
    {fromY:H*0.25,toY:fy+32+6*26+8,color:'#bc8cff',label:'consist'}
  ];
  arrowTargets.forEach(function(at){
    ctx.strokeStyle=at.color+'44';ctx.lineWidth=1;ctx.setLineDash([4,3]);
    ctx.beginPath();ctx.moveTo(arrowX+W*0.08,at.fromY);ctx.quadraticCurveTo(arrowX+W*0.12,at.toY,fx+fw,at.toY);ctx.stroke();
    ctx.setLineDash([]);
    /* arrowhead */
    ctx.fillStyle=at.color+'66';ctx.beginPath();ctx.moveTo(fx+fw,at.toY-3);ctx.lineTo(fx+fw+5,at.toY);ctx.lineTo(fx+fw,at.toY+3);ctx.fill();
  });

  /* Right: expanded dropdown showing terms */
  var ddx=W*0.62,ddy=H*0.06,ddw=W*0.34,ddh=H*0.50;
  rr(ddx,ddy,ddw,ddh,6);ctx.fillStyle='rgba(22,27,34,.8)';ctx.fill();ctx.strokeStyle='#58a6ff44';ctx.lineWidth=1;ctx.stroke();
  ctx.fillStyle='#58a6ff';ctx.font='bold 9px sans-serif';ctx.textAlign='left';ctx.fillText('QComboBox — Dropdown',ddx+10,ddy+14);
  ctx.fillStyle='#8b949e';ctx.font='7px sans-serif';ctx.fillText('Populated from thesaurus query',ddx+10,ddy+26);

  var ddTerms=['strato','muro','taglio','riempimento','pavimento','focolare','battuto','buca di palo','acciottolato'];
  ddTerms.forEach(function(term,i){
    var ry=ddy+34+i*16;
    if(ry+14>ddy+ddh-6)return;
    var isSelected=term==='strato';
    rr(ddx+6,ry,ddw-12,14,2);ctx.fillStyle=isSelected?'#58a6ff22':'#0d111766';ctx.fill();
    if(isSelected){ctx.strokeStyle='#58a6ff55';ctx.lineWidth=0.8;ctx.stroke();}
    ctx.fillStyle=isSelected?'#58a6ff':'#e6edf3';ctx.font=(isSelected?'bold ':'')+'8px sans-serif';ctx.textAlign='left';ctx.fillText(term,ddx+12,ry+10);
  });

  /* Bottom right: auto-complete visualization */
  var acy=H*0.62,acx=W*0.62,acw=W*0.34;
  rr(acx,acy,acw,H*0.28,6);ctx.fillStyle='rgba(22,27,34,.8)';ctx.fill();ctx.strokeStyle='#3fb95044';ctx.lineWidth=1;ctx.stroke();
  ctx.fillStyle='#3fb950';ctx.font='bold 9px sans-serif';ctx.textAlign='left';ctx.fillText('QCompleter — Auto-complete',acx+10,acy+14);

  /* Search input */
  rr(acx+8,acy+22,acw-16,16,3);ctx.fillStyle='#0d1117';ctx.fill();ctx.strokeStyle='#3fb95055';ctx.lineWidth=0.8;ctx.stroke();
  var typed='str';
  var typedLen=Math.min(3,Math.floor((t%3)*2)+1);
  var displayText=typed.substring(0,typedLen);
  ctx.fillStyle='#e6edf3';ctx.font='8px monospace';ctx.textAlign='left';ctx.fillText(displayText,acx+14,acy+33);
  /* Cursor blink */
  if(Math.sin(t*4)>0){
    var tw2=ctx.measureText(displayText).width;
    ctx.fillStyle='#3fb950';ctx.fillRect(acx+14+tw2+1,acy+24,1,12);
  }

  /* Suggestions */
  var suggestions=['strato','struttura','strada'];
  suggestions.forEach(function(s,i){
    var sy=acy+42+i*14;
    rr(acx+8,sy,acw-16,12,2);ctx.fillStyle=i===0?'#3fb95015':'#0d111766';ctx.fill();
    ctx.fillStyle=i===0?'#3fb950':'#8b949e';ctx.font='7px sans-serif';ctx.textAlign='left';ctx.fillText(s,acx+14,sy+9);
  });

  /* Standardization badge */
  if(A.step>=4){
    var bdy=H*0.92;
    var pulse4=Math.sin(t*2)*0.3+0.7;
    rr(W*0.25,bdy-10,W*0.50,20,4);ctx.fillStyle='#3fb95011';ctx.fill();
    ctx.strokeStyle='#3fb950'+Math.round(pulse4*80).toString(16).padStart(2,'0');ctx.lineWidth=1.2;ctx.stroke();
    ctx.fillStyle='#3fb950';ctx.font='bold 8px sans-serif';ctx.textAlign='center';
    ctx.fillText('All forms share the same controlled vocabulary — data consistency guaranteed',W*0.5,bdy+3);
  }
}

function drawScene(ts){
  var W=cv.width/(window.devicePixelRatio||1),H=cv.height/(window.devicePixelRatio||1);
  ctx.clearRect(0,0,W,H);var t=ts*0.001;
  A.animT=t;
  if(A.sc===0)drawScene0(W,H,t);
  else if(A.sc===1)drawScene1(W,H,t);
  else if(A.sc===2)drawScene2(W,H,t);
  else if(A.sc===3)drawScene3(W,H,t);
}

function load(i){A.sc=i;A.step=0;A.steps=SC[i].steps;clearTimeout(A.timer);hlCat(null);A.hlLang=null;
  updStats({cat:0,terms:0,used:0});$('sLang').textContent='it';
  logE.innerHTML='';A.logN=0;updDots();updDesc(SC[i].desc);exec(0);}
function exec(si){if(si<0||si>=A.steps.length)return;A.step=si;var s=A.steps[si];
  addLog(s.log,s.type);if(s.cat!==undefined)hlCat(s.cat);if(s.lang!==undefined)updLang(s.lang);if(s.stats)updStats(s.stats);
  if(s.d)updDesc('<strong>'+SC[A.sc].title+':</strong> '+s.d);updDots();if(A.mode==='auto'&&A.playing)schedNext();}
function schedNext(){clearTimeout(A.timer);var last=A.step>=A.steps.length-1;
  if(last&&A.looping){A.timer=setTimeout(function(){if(A.playing&&A.mode==='auto'&&A.looping){var n=(A.sc+1)%SC.length;sel.value=n;load(n);}},3000/A.speed);return;}
  if(last)return;var d=2200;var s=A.steps[A.step];if(s.type==='success')d=2500;
  A.timer=setTimeout(function(){if(A.playing&&A.mode==='auto')exec(A.step+1);},d/A.speed);}

sel.addEventListener('change',function(){load(+sel.value);});
bA.addEventListener('click',function(){A.mode='auto';bA.classList.add('on');bM.classList.remove('on');bPr.disabled=bNx.disabled=true;if(A.playing)schedNext();});
bM.addEventListener('click',function(){A.mode='manual';bM.classList.add('on');bA.classList.remove('on');bPr.disabled=bNx.disabled=false;clearTimeout(A.timer);});
bPP.addEventListener('click',function(){A.playing=!A.playing;bPP.innerHTML=A.playing?'&#10074;&#10074;':'&#9654;';if(A.playing&&A.mode==='auto')schedNext();else clearTimeout(A.timer);});
bPr.addEventListener('click',function(){if(A.step>0){logE.innerHTML='';exec(A.step-1);}});
bNx.addEventListener('click',function(){if(A.step<A.steps.length-1)exec(A.step+1);});
bRe.addEventListener('click',function(){A.playing=true;bPP.innerHTML='&#10074;&#10074;';load(A.sc);});
bL.addEventListener('click',function(){A.looping=!A.looping;bL.classList.toggle('on',A.looping);bSt.style.display=A.looping?'':'none';bL.innerHTML=A.looping?'&#8635; Looping':'&#8635; Loop';if(A.looping&&A.playing&&A.mode==='auto'&&A.step>=A.steps.length-1)schedNext();});
bSt.addEventListener('click',function(){A.looping=false;A.playing=false;bL.classList.remove('on');bL.innerHTML='&#8635; Loop';bSt.style.display='none';bPP.innerHTML='&#9654;';clearTimeout(A.timer);});
spB.forEach(function(b){b.addEventListener('click',function(){spB.forEach(function(x){x.classList.remove('on');});b.classList.add('on');A.speed=+b.dataset.s;if(A.playing&&A.mode==='auto')schedNext();});});
document.addEventListener('keydown',function(e){
  if(e.key===' '){e.preventDefault();bPP.click();}
  if(e.key==='ArrowRight'&&A.mode==='manual')bNx.click();
  if(e.key==='ArrowLeft'&&A.mode==='manual')bPr.click();
  if(e.key==='r'||e.key==='R')bRe.click();
  if(e.key==='l'||e.key==='L')bL.click();
  if((e.key==='s'||e.key==='S')&&A.looping)bSt.click();
  if(e.key>='1'&&e.key<='4'){sel.value=+e.key-1;load(+e.key-1);}
});
function renderLoop(ts){drawScene(ts);requestAnimationFrame(renderLoop);}
resize();requestAnimationFrame(renderLoop);load(0);
})();
</script>
</body>
</html>
