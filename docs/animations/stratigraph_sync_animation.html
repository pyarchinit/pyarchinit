<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>StratiGraph Sync Architecture — Interactive Animation</title>
<style>
/* ===== RESET & BASE ===== */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html { font-size: 14px; }
body {
  font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
  background: #0f1923;
  color: #e0e8f0;
  height: 100vh;
  overflow: hidden;
}

/* ===== LAYOUT ===== */
.app {
  display: -webkit-flex;
  display: flex;
  -webkit-flex-direction: column;
  flex-direction: column;
  height: 100vh;
}
.header {
  width: 100%;
  -webkit-flex: 0 0 auto;
  flex: 0 0 auto;
  background: #162230;
  border-bottom: 1px solid rgba(79,195,247,0.2);
  padding: 12px 24px;
  display: -webkit-flex;
  display: flex;
  -webkit-align-items: center;
  align-items: center;
  -webkit-justify-content: space-between;
  justify-content: space-between;
  -webkit-flex-wrap: wrap;
  flex-wrap: wrap;
}
.header > * {
  margin: 6px 0;
}
.header h1 {
  font-size: 1.3rem;
  font-weight: 600;
  color: #4fc3f7;
  letter-spacing: 0.5px;
}
.header h1 span { color: #8899aa; font-weight: 400; }
.middle {
  -webkit-flex: 1;
  flex: 1;
  display: -webkit-flex;
  display: flex;
  overflow: hidden;
  min-height: 0;
}
.main-area {
  -webkit-flex: 1 1 0%;
  flex: 1 1 0%;
  display: -webkit-flex;
  display: flex;
  -webkit-flex-direction: column;
  flex-direction: column;
  overflow: hidden;
  min-width: 0;
  min-height: 0;
}
.sidebar {
  width: 240px;
  -webkit-flex: 0 0 240px;
  flex: 0 0 240px;
  background: #162230;
  border-left: 1px solid rgba(79,195,247,0.15);
  padding: 16px;
  overflow-y: auto;
  display: -webkit-flex;
  display: flex;
  -webkit-flex-direction: column;
  flex-direction: column;
}
.sidebar > * {
  margin-bottom: 16px;
}
.sidebar > *:last-child {
  margin-bottom: 0;
}
.timeline-area {
  background: #162230;
  border-top: 1px solid rgba(79,195,247,0.15);
  padding: 12px 24px;
  max-height: 180px;
  overflow-y: auto;
}
/* sidebar alignment */
.sidebar {
  -webkit-align-self: stretch;
  align-self: stretch;
}

/* ===== CONTROLS ===== */
.controls {
  display: -webkit-flex;
  display: flex;
  -webkit-align-items: center;
  align-items: center;
  -webkit-flex-wrap: wrap;
  flex-wrap: wrap;
}
.controls > * {
  margin: 2px 4px;
}
.controls button {
  background: #1c2e40;
  border: 1px solid rgba(79,195,247,0.3);
  color: #e0e8f0;
  padding: 6px 14px;
  border-radius: 8px;
  cursor: pointer;
  font-size: 0.85rem;
  -webkit-transition: all 0.2s;
  transition: all 0.2s;
  display: -webkit-inline-flex;
  display: inline-flex;
  -webkit-align-items: center;
  align-items: center;
}
.controls button:hover { background: rgba(79,195,247,0.15); border-color: #4fc3f7; }
.controls button.active { background: #4fc3f7; color: #000; border-color: #4fc3f7; }
.controls button:disabled { opacity: 0.4; cursor: default; }
.controls select {
  background: #1c2e40;
  border: 1px solid rgba(79,195,247,0.3);
  color: #e0e8f0;
  padding: 6px 10px;
  border-radius: 8px;
  font-size: 0.85rem;
  cursor: pointer;
}
.speed-group, .mode-group {
  display: -webkit-inline-flex;
  display: inline-flex;
}
.speed-group > *, .mode-group > * {
  margin: 0 !important;
}
.speed-group button, .mode-group button { border-radius: 0; }
.speed-group button:first-child, .mode-group button:first-child { border-radius: 8px 0 0 8px; }
.speed-group button:last-child, .mode-group button:last-child { border-radius: 0 8px 8px 0; }

/* ===== STATE DIAGRAM (Upper Area) ===== */
.state-diagram-wrap {
  -webkit-flex: 0 0 auto;
  flex: 0 0 auto;
  padding: 16px 24px;
  display: -webkit-flex;
  display: flex;
  -webkit-justify-content: center;
  justify-content: center;
}
.state-diagram-wrap svg { max-width: 100%; height: auto; }

/* ===== SCENE (Central Area) ===== */
.scene-wrap {
  -webkit-flex: 1;
  flex: 1;
  position: relative;
  overflow: hidden;
  min-height: 0;
}
.scene-canvas {
  width: 100%;
  height: 100%;
  display: block;
}

/* ===== SIDEBAR WIDGETS ===== */
.widget {
  background: #1c2e40;
  border-radius: 8px;
  padding: 14px;
  border: 1px solid rgba(79,195,247,0.1);
}
.widget h3 {
  font-size: 0.75rem;
  text-transform: uppercase;
  letter-spacing: 1px;
  color: #8899aa;
  margin-bottom: 10px;
}
.connectivity-indicator {
  display: -webkit-flex;
  display: flex;
  -webkit-align-items: center;
  align-items: center;
  font-size: 1rem;
  font-weight: 600;
}
.connectivity-indicator > * {
  margin-right: 10px;
}
.connectivity-indicator > *:last-child {
  margin-right: 0;
}
.wifi-icon {
  width: 32px; height: 32px;
  -webkit-transition: all 0.3s;
  transition: all 0.3s;
}
.wifi-icon.online { -webkit-filter: drop-shadow(0 0 6px #66bb6a); filter: drop-shadow(0 0 6px #66bb6a); }
.wifi-icon.offline { -webkit-filter: drop-shadow(0 0 6px #ef5350); filter: drop-shadow(0 0 6px #ef5350); }
.conn-label { -webkit-transition: color 0.3s; transition: color 0.3s; }
.conn-label.online { color: #66bb6a; }
.conn-label.offline { color: #ef5350; }
.debounce-bar {
  margin-top: 8px;
  height: 4px;
  background: rgba(255,255,255,0.1);
  border-radius: 2px;
  overflow: hidden;
}
.debounce-bar-fill {
  height: 100%;
  background: #4fc3f7;
  width: 0%;
  -webkit-transition: width 0.3s;
  transition: width 0.3s;
  border-radius: 2px;
}

.stat-row {
  display: -webkit-flex;
  display: flex;
  -webkit-justify-content: space-between;
  justify-content: space-between;
  -webkit-align-items: center;
  align-items: center;
  padding: 6px 0;
  border-bottom: 1px solid rgba(255,255,255,0.05);
}
.stat-row:last-child { border-bottom: none; }
.stat-label { color: #8899aa; font-size: 0.85rem; }
.stat-value { font-weight: 600; font-size: 0.95rem; font-variant-numeric: tabular-nums; }

.backoff-display {
  text-align: center;
  padding: 8px 0;
}
.backoff-timer {
  font-size: 2rem;
  font-weight: 700;
  font-variant-numeric: tabular-nums;
  color: #ffa726;
  text-shadow: 0 0 12px rgba(255,167,38,0.3);
}
.backoff-label { color: #8899aa; font-size: 0.8rem; margin-top: 4px; }
.backoff-intervals {
  display: -webkit-flex;
  display: flex;
  -webkit-flex-wrap: wrap;
  flex-wrap: wrap;
  margin-top: 8px;
}
.backoff-intervals .interval {
  font-size: 0.7rem;
  padding: 2px 6px;
  border-radius: 3px;
  background: rgba(255,255,255,0.05);
  color: #8899aa;
  border: 1px solid transparent;
  -webkit-transition: all 0.3s;
  transition: all 0.3s;
  margin: 2px;
}
.backoff-intervals .interval.active {
  background: rgba(255,167,38,0.15);
  color: #ffa726;
  border-color: #ffa726;
}
.backoff-intervals .interval.done {
  background: rgba(102,187,106,0.15);
  color: #66bb6a;
  border-color: #66bb6a;
}

.current-state-display {
  text-align: center;
  padding: 8px 0;
}
.current-state-name {
  font-size: 1.1rem;
  font-weight: 700;
  padding: 8px 12px;
  border-radius: 8px;
  display: inline-block;
  -webkit-transition: all 0.4s;
  transition: all 0.4s;
}

/* ===== TIMELINE LOG ===== */
.timeline-area h3 {
  font-size: 0.75rem;
  text-transform: uppercase;
  letter-spacing: 1px;
  color: #8899aa;
  margin-bottom: 8px;
}
.log-entries {
  display: -webkit-flex;
  display: flex;
  -webkit-flex-direction: column;
  flex-direction: column;
}
.log-entries > * {
  margin-bottom: 4px;
}
.log-entry {
  display: -webkit-flex;
  display: flex;
  font-size: 0.85rem;
  padding: 4px 8px;
  border-radius: 4px;
  -webkit-animation: logFadeIn 0.3s ease;
  animation: logFadeIn 0.3s ease;
  -webkit-align-items: flex-start;
  align-items: flex-start;
}
.log-entry > * {
  margin-right: 10px;
}
.log-entry > *:last-child {
  margin-right: 0;
}
@-webkit-keyframes logFadeIn {
  from { opacity: 0; -webkit-transform: translateY(-4px); transform: translateY(-4px); }
  to { opacity: 1; -webkit-transform: none; transform: none; }
}
@keyframes logFadeIn {
  from { opacity: 0; -webkit-transform: translateY(-4px); transform: translateY(-4px); }
  to { opacity: 1; -webkit-transform: none; transform: none; }
}
.log-time {
  color: #8899aa;
  font-variant-numeric: tabular-nums;
  min-width: 50px;
  -webkit-flex-shrink: 0;
  flex-shrink: 0;
}
.log-icon { -webkit-flex-shrink: 0; flex-shrink: 0; width: 18px; text-align: center; }
.log-text { -webkit-flex: 1; flex: 1; }
.log-entry.info { background: rgba(79,195,247,0.05); }
.log-entry.success { background: rgba(102,187,106,0.08); }
.log-entry.warning { background: rgba(255,167,38,0.08); }
.log-entry.error { background: rgba(239,83,80,0.08); }

/* ===== SCENARIO DESCRIPTION PANEL ===== */
.desc-panel {
  background: #111820;
  border-top: 2px solid rgba(79,195,247,0.18);
  padding: 14px 24px;
  min-height: 68px;
  max-height: 130px;
  overflow-y: auto;
  font-size: 0.9rem;
  line-height: 1.7;
  -webkit-flex-shrink: 0;
  flex-shrink: 0;
  color: #c8d4e2;
  -webkit-transition: opacity 0.3s;
  transition: opacity 0.3s;
}
.desc-panel strong { color: #4fc3f7; font-weight: 600; font-family: 'Consolas','Monaco','Courier New',monospace; font-size: 0.86rem; background: rgba(79,195,247,0.08); padding: 1px 5px; border-radius: 3px; }

/* ===== STEP INDICATOR ===== */
.step-indicator {
  position: absolute;
  bottom: 12px;
  left: 50%;
  -webkit-transform: translateX(-50%);
  transform: translateX(-50%);
  display: -webkit-flex;
  display: flex;
  z-index: 5;
}
.step-indicator > * {
  margin: 0 3px;
}
.step-dot {
  width: 10px;
  height: 10px;
  border-radius: 50%;
  background: rgba(255,255,255,0.15);
  border: 1px solid rgba(255,255,255,0.2);
  -webkit-transition: all 0.3s;
  transition: all 0.3s;
}
.step-dot.active { background: #4fc3f7; border-color: #4fc3f7; box-shadow: 0 0 8px #4fc3f7; }
.step-dot.done { background: #66bb6a; border-color: #66bb6a; }

/* ===== KG OVERLAY (Scenario 4) ===== */
.kg-overlay {
  position: absolute;
  top: 0;
  right: 0;
  bottom: 0;
  left: 0;
  display: none;
  -webkit-justify-content: center;
  justify-content: center;
  -webkit-align-items: center;
  align-items: center;
}
.kg-overlay.visible {
  display: -webkit-flex;
  display: flex;
}
.kg-overlay svg { max-width: 100%; max-height: 100%; }

/* ===== RESPONSIVE ===== */
@media (max-width: 900px) {
  .middle {
    display: block;
  }
  .sidebar {
    width: 100%;
    -webkit-flex-direction: row;
    flex-direction: row;
    -webkit-flex-wrap: wrap;
    flex-wrap: wrap;
    border-left: none;
    border-top: 1px solid rgba(79,195,247,0.15);
  }
  .sidebar > .widget {
    -webkit-flex: 1 1 180px;
    flex: 1 1 180px;
    margin: 4px;
  }
  .desc-panel { max-height: 90px; min-height: 50px; font-size: 0.84rem; padding: 10px 16px; }
}
@media (max-width: 600px) {
  .header { padding: 8px 12px; }
  .header h1 { font-size: 1rem; }
  .state-diagram-wrap { padding: 8px 12px; }
  .timeline-area { padding: 8px 12px; }
}

/* ===== ANIMATIONS ===== */
@-webkit-keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.5; } }
@keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.5; } }
@-webkit-keyframes glow {
  0%,100% { -webkit-filter: drop-shadow(0 0 4px currentColor); filter: drop-shadow(0 0 4px currentColor); }
  50% { -webkit-filter: drop-shadow(0 0 12px currentColor); filter: drop-shadow(0 0 12px currentColor); }
}
@keyframes glow {
  0%,100% { -webkit-filter: drop-shadow(0 0 4px currentColor); filter: drop-shadow(0 0 4px currentColor); }
  50% { -webkit-filter: drop-shadow(0 0 12px currentColor); filter: drop-shadow(0 0 12px currentColor); }
}
.state-active { -webkit-animation: glow 1.5s ease-in-out infinite; animation: glow 1.5s ease-in-out infinite; }

/* Scrollbar */
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: #0f1923; }
::-webkit-scrollbar-thumb { background: #1c2e40; border-radius: 3px; }
</style>
</head>
<body>

<div class="app">

  <!-- HEADER -->
  <div class="header">
    <h1>StratiGraph Sync Architecture <span>— Horizon Europe Interactive Demo</span></h1>
    <div class="controls">
      <select id="scenarioSelect">
        <option value="0">1. Normal Flow (Online)</option>
        <option value="1">2. Offline → Auto-Sync</option>
        <option value="2">3. Error + Retry (Backoff)</option>
        <option value="3">4. Knowledge Graph Overview</option>
      </select>
      <div class="mode-group">
        <button id="btnAuto" class="active" title="Auto-play">&#9654; Auto</button>
        <button id="btnManual" title="Manual step-by-step">&#9998; Manual</button>
      </div>
      <div class="speed-group">
        <button class="speed-btn active" data-speed="1">1x</button>
        <button class="speed-btn" data-speed="2">2x</button>
        <button class="speed-btn" data-speed="4">4x</button>
      </div>
      <button id="btnPlayPause" title="Play / Pause">&#10074;&#10074; Pause</button>
      <button id="btnPrev" disabled title="Previous step">&larr; Back</button>
      <button id="btnNext" disabled title="Next step">Next &rarr;</button>
      <button id="btnRestart" title="Restart scenario">&#8634; Restart</button>
      <button id="btnLoop" title="Loop all scenarios continuously (L)">&#8635; Loop</button>
      <button id="btnStop" title="Stop and reset (S)" style="display:none;">&#9632; Stop</button>
    </div>
  </div>

  <!-- MIDDLE (main + sidebar) -->
  <div class="middle">

  <!-- MAIN AREA -->
  <div class="main-area">

    <!-- State Diagram (Upper) -->
    <div class="state-diagram-wrap">
      <svg id="stateDiagram" viewBox="0 0 780 130" width="780" height="130">
        <defs>
          <marker id="arrowhead" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto">
            <polygon points="0 0, 8 3, 0 6" fill="#4fc3f7" opacity="0.6"/>
          </marker>
          <filter id="glowFilter">
            <feGaussianBlur stdDeviation="3" result="blur"/>
            <feMerge><feMergeNode in="blur"/><feMergeNode in="SourceGraphic"/></feMerge>
          </filter>
        </defs>
        <!-- Arrows -->
        <line x1="135" y1="65" x2="183" y2="65" stroke="#4fc3f7" stroke-width="1.5" opacity="0.3" marker-end="url(#arrowhead)" class="state-arrow" data-from="0" data-to="1"/>
        <line x1="265" y1="65" x2="313" y2="65" stroke="#4fc3f7" stroke-width="1.5" opacity="0.3" marker-end="url(#arrowhead)" class="state-arrow" data-from="1" data-to="2"/>
        <line x1="395" y1="65" x2="443" y2="65" stroke="#4fc3f7" stroke-width="1.5" opacity="0.3" marker-end="url(#arrowhead)" class="state-arrow" data-from="2" data-to="3"/>
        <line x1="525" y1="65" x2="573" y2="65" stroke="#4fc3f7" stroke-width="1.5" opacity="0.3" marker-end="url(#arrowhead)" class="state-arrow" data-from="3" data-to="4"/>
        <!-- Fail arrow (queue to failed) -->
        <path d="M500,90 Q500,120 590,120 Q660,120 660,90" fill="none" stroke="#ef5350" stroke-width="1.5" opacity="0.2" marker-end="url(#arrowhead)" class="state-arrow" data-from="3" data-to="5"/>
        <!-- Retry arrow (failed to queue) -->
        <path d="M660,50 Q660,20 590,20 Q500,20 500,50" fill="none" stroke="#ffa726" stroke-width="1.5" opacity="0.2" stroke-dasharray="4,3" marker-end="url(#arrowhead)" class="state-arrow" data-from="5" data-to="3"/>
        <!-- Success loop back -->
        <path d="M650,40 Q700,0 730,0 Q760,0 760,20 Q760,130 50,130 Q20,130 20,100 Q20,65 60,65" fill="none" stroke="#66bb6a" stroke-width="1.5" opacity="0.2" marker-end="url(#arrowhead)" class="state-arrow" data-from="4" data-to="0"/>

        <!-- State nodes -->
        <g class="state-node" data-state="0" transform="translate(95,65)">
          <circle r="38" fill="#1c2e40" stroke="#42a5f5" stroke-width="2.5"/>
          <!-- Pencil icon -->
          <path d="M-8,-14 L4,-2 L1,1 L-5,1 L-5,-5 Z M5,-3 L8,-6 L6,-8 L3,-5 Z" fill="none" stroke="#42a5f5" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
          <text y="14" text-anchor="middle" fill="#e0e8f0" font-size="8" font-weight="600">EDITING</text>
        </g>
        <g class="state-node" data-state="1" transform="translate(225,65)">
          <circle r="38" fill="#1c2e40" stroke="#ffa726" stroke-width="2.5"/>
          <!-- Box/package icon -->
          <rect x="-10" y="-14" width="20" height="16" rx="2" fill="none" stroke="#ffa726" stroke-width="1.5"/>
          <line x1="-10" y1="-8" x2="10" y2="-8" stroke="#ffa726" stroke-width="1.5"/>
          <line x1="0" y1="-14" x2="0" y2="-8" stroke="#ffa726" stroke-width="1.5"/>
          <text y="14" text-anchor="middle" fill="#e0e8f0" font-size="8" font-weight="600">EXPORT</text>
        </g>
        <g class="state-node" data-state="2" transform="translate(355,65)">
          <circle r="38" fill="#1c2e40" stroke="#ab47bc" stroke-width="2.5"/>
          <!-- Shield/check icon -->
          <path d="M0,-16 L10,-10 L10,-2 C10,6 0,12 0,12 C0,12 -10,6 -10,-2 L-10,-10 Z" fill="none" stroke="#ab47bc" stroke-width="1.5"/>
          <polyline points="-4,-2 -1,2 5,-5" fill="none" stroke="#ab47bc" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
          <text y="14" text-anchor="middle" fill="#e0e8f0" font-size="8" font-weight="600">VALIDATE</text>
        </g>
        <g class="state-node" data-state="3" transform="translate(485,65)">
          <circle r="38" fill="#1c2e40" stroke="#78909c" stroke-width="2.5"/>
          <!-- Clock icon -->
          <circle cx="0" cy="-5" r="11" fill="none" stroke="#78909c" stroke-width="1.5"/>
          <polyline points="0,-10 0,-5 5,-2" fill="none" stroke="#78909c" stroke-width="1.5" stroke-linecap="round"/>
          <text y="14" text-anchor="middle" fill="#e0e8f0" font-size="8" font-weight="600">QUEUE</text>
        </g>
        <g class="state-node" data-state="4" transform="translate(615,65)">
          <circle r="38" fill="#1c2e40" stroke="#66bb6a" stroke-width="2.5"/>
          <!-- Checkmark icon -->
          <polyline points="-8,-4 -3,4 8,-8" fill="none" stroke="#66bb6a" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
          <text y="14" text-anchor="middle" fill="#e0e8f0" font-size="8" font-weight="600">SUCCESS</text>
        </g>
        <g class="state-node" data-state="5" transform="translate(695,65)">
          <circle r="38" fill="#1c2e40" stroke="#ef5350" stroke-width="2.5"/>
          <!-- X icon -->
          <line x1="-7" y1="-11" x2="7" y2="1" stroke="#ef5350" stroke-width="2.5" stroke-linecap="round"/>
          <line x1="7" y1="-11" x2="-7" y2="1" stroke="#ef5350" stroke-width="2.5" stroke-linecap="round"/>
          <text y="14" text-anchor="middle" fill="#e0e8f0" font-size="8" font-weight="600">FAILED</text>
        </g>
      </svg>
    </div>

    <!-- Scene (Central animated area) -->
    <div class="scene-wrap">
      <canvas id="sceneCanvas" class="scene-canvas"></canvas>
      <div class="step-indicator" id="stepIndicator"></div>
      <!-- KG Overlay for scenario 4 -->
      <div class="kg-overlay" id="kgOverlay">
        <svg id="kgSvg" viewBox="0 0 700 400" width="700" height="400"></svg>
      </div>
    </div>
    <div class="desc-panel" id="scenarioDesc"></div>
  </div>

  <!-- SIDEBAR -->
  <div class="sidebar">
    <div class="widget">
      <h3>Connectivity</h3>
      <div class="connectivity-indicator">
        <svg class="wifi-icon online" id="wifiIcon" viewBox="0 0 24 24">
          <path id="wifi3" d="M1.5 8.5c5.8-5.8 15.2-5.8 21 0" fill="none" stroke="#66bb6a" stroke-width="2" stroke-linecap="round"/>
          <path id="wifi2" d="M5.5 12.5c3.6-3.6 9.4-3.6 13 0" fill="none" stroke="#66bb6a" stroke-width="2" stroke-linecap="round"/>
          <path id="wifi1" d="M9.5 16.5c1.4-1.4 3.6-1.4 5 0" fill="none" stroke="#66bb6a" stroke-width="2" stroke-linecap="round"/>
          <circle cx="12" cy="20" r="1.5" fill="#66bb6a" id="wifiDot"/>
        </svg>
        <span class="conn-label online" id="connLabel">ONLINE</span>
      </div>
      <div class="debounce-bar"><div class="debounce-bar-fill" id="debounceFill"></div></div>
      <div style="font-size:0.7rem;color:#8899aa;margin-top:4px;" id="debounceText">Debounce: 2 consecutive checks</div>
    </div>

    <div class="widget">
      <h3>Queue Status</h3>
      <div class="stat-row">
        <span class="stat-label">Bundles in Queue</span>
        <span class="stat-value" id="queueCount">0</span>
      </div>
      <div class="stat-row">
        <span class="stat-label">Synced Total</span>
        <span class="stat-value" id="syncedCount">0</span>
      </div>
      <div class="stat-row">
        <span class="stat-label">Failed Total</span>
        <span class="stat-value" id="failedCount">0</span>
      </div>
    </div>

    <div class="widget">
      <h3>Backoff Timer</h3>
      <div class="backoff-display">
        <div class="backoff-timer" id="backoffTimer">--</div>
        <div class="backoff-label" id="backoffLabel">No active retry</div>
      </div>
      <div class="backoff-intervals" id="backoffIntervals">
        <span class="interval" data-i="0">30s</span>
        <span class="interval" data-i="1">60s</span>
        <span class="interval" data-i="2">120s</span>
        <span class="interval" data-i="3">300s</span>
        <span class="interval" data-i="4">900s</span>
      </div>
    </div>

    <div class="widget">
      <h3>Current State</h3>
      <div class="current-state-display">
        <span class="current-state-name" id="currentStateName" style="background:rgba(66,165,245,0.15);color:#42a5f5;">OFFLINE_EDITING</span>
      </div>
    </div>
  </div>

  </div>

  <!-- TIMELINE LOG -->
  <div class="timeline-area">
    <h3>Event Log</h3>
    <div class="log-entries" id="logEntries"></div>
  </div>
</div>

<script>
// ===================================================================
// StratiGraph Sync Animation — Main Application (ES5 / Old WebKit)
// ===================================================================

(function() {

// ---- Utility: pad number with leading zeros ----
function padStart(num, len, ch) {
  var s = String(num);
  if (!ch) ch = '0';
  while (s.length < len) {
    s = ch + s;
  }
  return s;
}

// ---- Constants ----
var STATE_NAMES = [
  'OFFLINE_EDITING', 'LOCAL_EXPORT', 'LOCAL_VALIDATION',
  'QUEUED_FOR_SYNC', 'SYNC_SUCCESS', 'SYNC_FAILED'
];
var STATE_COLORS = ['#42a5f5','#ffa726','#ab47bc','#78909c','#66bb6a','#ef5350'];
var STATE_POSITIONS = [
  {x:95,y:65},{x:225,y:65},{x:355,y:65},
  {x:485,y:65},{x:615,y:65},{x:695,y:65}
];
var BACKOFF_INTERVALS = [30, 60, 120, 300, 900];

// ---- State ----
var app = {
  scenario: 0,
  mode: 'auto',
  speed: 1,
  playing: true,
  currentStep: 0,
  currentState: 0,
  online: true,
  queueCount: 0,
  syncedCount: 0,
  failedCount: 0,
  backoffIndex: -1,
  backoffRemaining: 0,
  steps: [],
  animationTime: 0,
  lastTimestamp: 0,
  pendingStepTimer: null,
  particles: [],
  bundlePos: null,
  bundleTarget: null,
  bundleProgress: 0,
  sceneObjects: [],
  logCounter: 0,
  looping: false
};

// ---- DOM refs ----
function getEl(id) { return document.getElementById(id); }
var scenarioSelect = getEl('scenarioSelect');
var btnAuto = getEl('btnAuto');
var btnManual = getEl('btnManual');
var btnPlayPause = getEl('btnPlayPause');
var btnPrev = getEl('btnPrev');
var btnNext = getEl('btnNext');
var btnRestart = getEl('btnRestart');
var btnLoop = getEl('btnLoop');
var btnStop = getEl('btnStop');
var speedBtns = Array.prototype.slice.call(document.querySelectorAll('.speed-btn'));
var logEntries = getEl('logEntries');
var canvas = getEl('sceneCanvas');
var ctx = canvas.getContext('2d');
var scenarioDesc = getEl('scenarioDesc');
var stepIndicator = getEl('stepIndicator');
var kgOverlay = getEl('kgOverlay');

// ---- Scenario Definitions ----
function buildScenarios() {
  return [
    // Scenario 0: Normal Flow (Online)
    {
      title: 'Normal Flow (Online)',
      description: '<strong>Normal sync flow:</strong> Archaeologist edits data on-site, exports a bundle, validates locally, queues for sync, and successfully uploads to the cloud.',
      steps: [
        { state:0, online:true, log:'Archaeologist opens PyArchInit and begins editing stratigraphic data.', type:'info', desc:'The archaeologist records field data using the QGIS plugin.' },
        { state:0, online:true, log:'Data entered: US 101 — Wall foundation, Period II, Phase 1.', type:'info', desc:'Detailed archaeological context is recorded.' },
        { state:1, online:true, log:'Triggering local export: packaging data into a sync bundle (ZIP).', type:'info', desc:'All modified records are serialized into a portable ZIP bundle.' },
        { state:1, online:true, log:'Bundle created: stratigraph_bundle_20260209_001.zip (2.4 MB)', type:'info', desc:'The bundle contains GeoJSON, metadata, and attachments.' },
        { state:2, online:true, log:'Running local validation: schema check, referential integrity...', type:'info', desc:'Validation ensures the bundle is well-formed before upload.' },
        { state:2, online:true, log:'Validation PASSED — bundle is ready for sync.', type:'success', desc:'All checks passed. The bundle can be synced.' },
        { state:3, online:true, log:'Bundle added to sync queue. Position: 1. Checking connectivity...', type:'info', queue:1, desc:'The bundle enters the sync queue.' },
        { state:3, online:true, log:'Connectivity confirmed (2/2 checks). Starting upload...', type:'info', desc:'Debounce: two consecutive online checks confirm real connectivity.' },
        { state:4, online:true, log:'Upload complete. Server acknowledged bundle. SYNC_SUCCESS!', type:'success', queue:0, synced:1, desc:'The cloud server received and processed the bundle.' },
        { state:0, online:true, log:'Returning to OFFLINE_EDITING. Ready for new data entry.', type:'info', desc:'The cycle is complete. The system is ready for the next edit.' }
      ]
    },
    // Scenario 1: Offline → Auto-Sync
    {
      title: 'Offline → Auto-Sync',
      description: '<strong>Offline scenario:</strong> The archaeologist works without connectivity. When the connection returns, the queued bundle auto-syncs.',
      steps: [
        { state:0, online:false, log:'Working offline on-site. No internet available.', type:'warning', desc:'The plugin detects no connectivity and operates in offline mode.' },
        { state:0, online:false, log:'Recording data: Tomb 14, individual burial, supine position.', type:'info', desc:'Archaeological recording continues without network.' },
        { state:1, online:false, log:'Exporting bundle locally...', type:'info', desc:'Export works identically offline.' },
        { state:2, online:false, log:'Local validation running...', type:'info', desc:'Validation is entirely local — no network needed.' },
        { state:2, online:false, log:'Validation PASSED.', type:'success', desc:'Bundle is valid and ready.' },
        { state:3, online:false, log:'Bundle queued. No connectivity — waiting for connection...', type:'warning', queue:1, desc:'The bundle sits in the queue until the network returns.' },
        { state:3, online:false, log:'Connectivity check: OFFLINE. Bundle remains queued.', type:'warning', desc:'Periodic checks detect no network.' },
        { state:3, online:true, log:'Network detected! Running debounce (check 1/2)...', type:'info', desc:'First connectivity check — need one more to confirm.' },
        { state:3, online:true, log:'Debounce passed (check 2/2). Auto-syncing queued bundle...', type:'info', desc:'Two consecutive checks confirm stable connectivity.' },
        { state:4, online:true, log:'AUTO-SYNC complete! Bundle uploaded successfully.', type:'success', queue:0, synced:1, desc:'The queued bundle was automatically synced when connectivity returned.' },
        { state:0, online:true, log:'Back to OFFLINE_EDITING. All data synchronized.', type:'info', desc:'Seamless transition back to editing.' }
      ]
    },
    // Scenario 2: Error + Retry with Backoff
    {
      title: 'Error + Retry (Backoff)',
      description: '<strong>Error & retry:</strong> Sync fails due to server error. Exponential backoff retries at increasing intervals until success.',
      steps: [
        { state:0, online:true, log:'Editing data: updating pottery inventory for Trench B.', type:'info', desc:'Normal editing session.' },
        { state:1, online:true, log:'Exporting sync bundle...', type:'info', desc:'Bundle creation.' },
        { state:2, online:true, log:'Validation PASSED.', type:'success', desc:'Bundle is valid.' },
        { state:3, online:true, log:'Attempting sync... uploading to server...', type:'info', queue:1, desc:'First sync attempt.' },
        { state:5, online:true, log:'SYNC_FAILED! Server returned 503 (Service Unavailable).', type:'error', failed:1, desc:'The server is temporarily down.' },
        { state:5, online:true, log:'Exponential backoff: retrying in 30s...', type:'warning', backoff:0, desc:'First backoff interval: 30 seconds.' },
        { state:3, online:true, log:'Retry #1: re-uploading bundle...', type:'info', desc:'Automatic retry after backoff.' },
        { state:5, online:true, log:'SYNC_FAILED again! Server returned 503.', type:'error', desc:'Server still unavailable.' },
        { state:5, online:true, log:'Exponential backoff: retrying in 60s...', type:'warning', backoff:1, desc:'Second backoff interval: 60 seconds (doubled).' },
        { state:3, online:true, log:'Retry #2: re-uploading bundle...', type:'info', desc:'Another retry attempt.' },
        { state:4, online:true, log:'SYNC_SUCCESS! Server recovered. Bundle accepted.', type:'success', queue:0, synced:1, desc:'The server came back and accepted the bundle.' },
        { state:0, online:true, log:'Back to OFFLINE_EDITING. Retry mechanism worked!', type:'info', desc:'Backoff strategy successfully handled transient failure.' }
      ]
    },
    // Scenario 3: Knowledge Graph Overview
    {
      title: 'Knowledge Graph Overview',
      description: '<strong>Knowledge Graph:</strong> Multiple archaeological tools (PyArchInit, GIS, photogrammetry, etc.) feed data into a central Knowledge Graph that enables cross-project queries.',
      steps: [
        { state:-1, online:true, log:'Knowledge Graph overview: multiple data sources feed the central KG.', type:'info', kg:'init', desc:'The Horizon Europe architecture uses a central Knowledge Graph.' },
        { state:-1, online:true, log:'PyArchInit exports stratigraphic data → KG node: Stratigraphy.', type:'info', kg:'pyarchinit', desc:'PyArchInit contributes stratigraphic relationships.' },
        { state:-1, online:true, log:'GIS exports spatial layers → KG node: Spatial Data.', type:'info', kg:'gis', desc:'Geographic layers are integrated as spatial knowledge.' },
        { state:-1, online:true, log:'Photogrammetry exports 3D models → KG node: 3D Models.', type:'info', kg:'photo', desc:'3D documentation enriches the knowledge base.' },
        { state:-1, online:true, log:'Finds database exports artifact records → KG node: Artifacts.', type:'info', kg:'finds', desc:'Material culture data feeds into artifact ontology.' },
        { state:-1, online:true, log:'Environmental analysis exports results → KG node: Environment.', type:'info', kg:'env', desc:'Environmental and dating analyses are linked.' },
        { state:-1, online:true, log:'All data interconnected in the KG. Cross-project queries enabled!', type:'success', kg:'all', desc:'The KG allows querying across all domains and projects.' },
        { state:-1, online:true, log:'Example query: "Find all Phase II walls with associated pottery dating 2nd c. AD"', type:'info', kg:'query', desc:'Semantic queries span multiple data sources via the KG.' }
      ]
    }
  ];
}

var SCENARIOS = buildScenarios();

// ===================================================================
// UI Updates
// ===================================================================

function updateConnectivity(online) {
  app.online = online;
  var icon = getEl('wifiIcon');
  var label = getEl('connLabel');
  var color = online ? '#66bb6a' : '#ef5350';
  if (online) {
    icon.className = 'wifi-icon online';
    label.className = 'conn-label online';
  } else {
    icon.className = 'wifi-icon offline';
    label.className = 'conn-label offline';
  }
  label.textContent = online ? 'ONLINE' : 'OFFLINE';
  var wifiIds = ['wifi1','wifi2','wifi3','wifiDot'];
  for (var w = 0; w < wifiIds.length; w++) {
    var wid = wifiIds[w];
    var wel = getEl(wid);
    if (wid === 'wifiDot') {
      wel.setAttribute('fill', color);
    } else {
      wel.setAttribute('stroke', color);
    }
  }
}

function updateQueueCount(n) {
  if (n !== undefined) app.queueCount = n;
  getEl('queueCount').textContent = app.queueCount;
}

function updateSyncedCount(n) {
  if (n !== undefined) app.syncedCount += n;
  getEl('syncedCount').textContent = app.syncedCount;
}

function updateFailedCount(n) {
  if (n !== undefined) app.failedCount += n;
  getEl('failedCount').textContent = app.failedCount;
}

function updateBackoff(index, remaining) {
  app.backoffIndex = index;
  app.backoffRemaining = remaining;
  var timer = getEl('backoffTimer');
  var label = getEl('backoffLabel');
  var intervals = getEl('backoffIntervals').children;
  if (index < 0) {
    timer.textContent = '--';
    timer.style.color = '#8899aa';
    label.textContent = 'No active retry';
    for (var i = 0; i < intervals.length; i++) {
      intervals[i].className = 'interval';
    }
  } else {
    timer.textContent = remaining + 's';
    timer.style.color = '#ffa726';
    label.textContent = 'Retry #' + (index + 1) + ' backoff';
    for (var j = 0; j < intervals.length; j++) {
      var cls = 'interval';
      if (j === index) cls += ' active';
      else if (j < index) cls += ' done';
      intervals[j].className = cls;
    }
  }
}

function updateCurrentState(index) {
  app.currentState = index;
  var el = getEl('currentStateName');
  if (index < 0) {
    el.textContent = 'KNOWLEDGE GRAPH';
    el.style.background = 'rgba(79,195,247,0.15)';
    el.style.color = '#4fc3f7';
  } else {
    el.textContent = STATE_NAMES[index];
    el.style.background = STATE_COLORS[index] + '22';
    el.style.color = STATE_COLORS[index];
  }
  // Update SVG state diagram highlights
  var stateNodes = Array.prototype.slice.call(document.querySelectorAll('.state-node'));
  for (var i = 0; i < stateNodes.length; i++) {
    var circle = stateNodes[i].getElementsByTagName('circle')[0];
    if (i === index) {
      circle.setAttribute('stroke-width', '4');
      // Add state-active class
      var existingClass = stateNodes[i].getAttribute('class') || '';
      if (existingClass.indexOf('state-active') === -1) {
        stateNodes[i].setAttribute('class', existingClass + ' state-active');
      }
      circle.style.filter = 'url(#glowFilter)';
    } else {
      circle.setAttribute('stroke-width', '2.5');
      // Remove state-active class
      var curClass = stateNodes[i].getAttribute('class') || '';
      stateNodes[i].setAttribute('class', curClass.replace(/\s*state-active/g, ''));
      circle.style.filter = '';
    }
  }
  // Highlight relevant arrows
  var arrows = Array.prototype.slice.call(document.querySelectorAll('.state-arrow'));
  for (var a = 0; a < arrows.length; a++) {
    var arrow = arrows[a];
    var from = parseInt(arrow.getAttribute('data-from'), 10);
    var to = parseInt(arrow.getAttribute('data-to'), 10);
    var isActive = from === index;
    arrow.setAttribute('opacity', isActive ? '0.9' : '0.2');
    arrow.setAttribute('stroke-width', isActive ? '2.5' : '1.5');
  }
}

function addLogEntry(text, type) {
  app.logCounter++;
  var time = new Date();
  var ts = padStart(time.getMinutes(), 2, '0') + ':' + padStart(time.getSeconds(), 2, '0');
  var icons = { info:'&#8505;', success:'&#10004;', warning:'&#9888;', error:'&#10008;' };
  var colors = { info:'#4fc3f7', success:'#66bb6a', warning:'#ffa726', error:'#ef5350' };
  var entry = document.createElement('div');
  entry.className = 'log-entry ' + type;
  entry.innerHTML = '<span class="log-time">' + ts + '</span><span class="log-icon" style="color:' + colors[type] + '">' + icons[type] + '</span><span class="log-text">' + text + '</span>';
  if (logEntries.firstChild) {
    logEntries.insertBefore(entry, logEntries.firstChild);
  } else {
    logEntries.appendChild(entry);
  }
  // Keep max 30 entries
  while (logEntries.children.length > 30) {
    logEntries.removeChild(logEntries.lastChild);
  }
}

function updateStepIndicator() {
  stepIndicator.innerHTML = '';
  var steps = app.steps;
  for (var i = 0; i < steps.length; i++) {
    var dot = document.createElement('div');
    dot.className = 'step-dot';
    if (i === app.currentStep) {
      dot.className += ' active';
    } else if (i < app.currentStep) {
      dot.className += ' done';
    }
    stepIndicator.appendChild(dot);
  }
}

function updateScenarioDesc(text) {
  scenarioDesc.innerHTML = text || '';
  scenarioDesc.style.opacity = text ? '1' : '0';
}

// ===================================================================
// Scene Canvas Rendering
// ===================================================================

function resizeCanvas() {
  var wrap = canvas.parentElement;
  var w = wrap.clientWidth;
  var h = wrap.clientHeight;
  if (canvas.width !== w || canvas.height !== h) {
    canvas.width = w;
    canvas.height = h;
  }
}

function drawRoundedRect(x, y, w, h, r) {
  ctx.beginPath();
  ctx.moveTo(x + r, y);
  ctx.lineTo(x + w - r, y);
  ctx.quadraticCurveTo(x + w, y, x + w, y + r);
  ctx.lineTo(x + w, y + h - r);
  ctx.quadraticCurveTo(x + w, y + h, x + w - r, y + h);
  ctx.lineTo(x + r, y + h);
  ctx.quadraticCurveTo(x, y + h, x, y + h - r);
  ctx.lineTo(x, y + r);
  ctx.quadraticCurveTo(x, y, x + r, y);
  ctx.closePath();
}

function drawScene(time) {
  var W = canvas.width;
  var H = canvas.height;
  ctx.clearRect(0, 0, W, H);

  if (app.scenario === 3) return; // KG scenario uses SVG overlay

  var t = time * 0.001;

  // Ground line
  ctx.strokeStyle = 'rgba(79,195,247,0.1)';
  ctx.lineWidth = 1;
  ctx.beginPath();
  ctx.moveTo(0, H * 0.78);
  ctx.lineTo(W, H * 0.78);
  ctx.stroke();

  // Dotted path connecting elements
  ctx.setLineDash([4, 4]);
  ctx.strokeStyle = 'rgba(79,195,247,0.15)';
  ctx.lineWidth = 1;
  ctx.beginPath();
  ctx.moveTo(W * 0.12, H * 0.55);
  ctx.lineTo(W * 0.88, H * 0.55);
  ctx.stroke();
  ctx.setLineDash([]);

  // Draw archaeologist (stick figure)
  var ax = W * 0.08, ay = H * 0.4;
  ctx.strokeStyle = '#42a5f5';
  ctx.lineWidth = 2;
  ctx.fillStyle = '#42a5f5';
  // Head
  ctx.beginPath(); ctx.arc(ax, ay, 8, 0, Math.PI * 2); ctx.fill();
  // Body
  ctx.beginPath(); ctx.moveTo(ax, ay + 8); ctx.lineTo(ax, ay + 30); ctx.stroke();
  // Arms
  ctx.beginPath(); ctx.moveTo(ax - 12, ay + 16); ctx.lineTo(ax + 12, ay + 16); ctx.stroke();
  // Legs
  ctx.beginPath(); ctx.moveTo(ax, ay + 30); ctx.lineTo(ax - 8, ay + 45); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(ax, ay + 30); ctx.lineTo(ax + 8, ay + 45); ctx.stroke();
  // Label
  ctx.font = '10px sans-serif';
  ctx.fillStyle = '#8899aa';
  ctx.textAlign = 'center';
  ctx.fillText('Archaeologist', ax, ay + 60);

  // Laptop
  var lx = W * 0.24, ly = H * 0.42;
  drawRoundedRect(lx - 20, ly - 12, 40, 28, 3);
  ctx.fillStyle = app.currentState === 0 ? 'rgba(66,165,245,0.2)' : 'rgba(30,40,50,0.6)';
  ctx.fill();
  ctx.strokeStyle = app.currentState === 0 ? '#42a5f5' : '#556677';
  ctx.lineWidth = 1.5;
  ctx.stroke();
  // Screen glow
  if (app.currentState === 0) {
    ctx.fillStyle = 'rgba(66,165,245,' + (0.3 + 0.15 * Math.sin(t * 3)) + ')';
    drawRoundedRect(lx - 16, ly - 8, 32, 18, 2);
    ctx.fill();
  }
  // Keyboard base
  ctx.fillStyle = '#334455';
  ctx.fillRect(lx - 22, ly + 17, 44, 4);
  ctx.fillStyle = '#8899aa';
  ctx.font = '10px sans-serif';
  ctx.textAlign = 'center';
  ctx.fillText('PyArchInit', lx, ly + 36);
  ctx.fillText('(QGIS Plugin)', lx, ly + 48);

  // Bundle/ZIP icon
  var bx = W * 0.44, by = H * 0.38;
  var bundleVisible = app.currentState >= 1 && app.currentState <= 4;
  if (bundleVisible || app.currentState === 5) {
    var bobY = by + 3 * Math.sin(t * 2);
    ctx.save();
    // Moving bundle based on state
    var drawX = bx, drawY = bobY;
    if (app.bundlePos) {
      drawX = app.bundlePos.x;
      drawY = app.bundlePos.y + 3 * Math.sin(t * 2);
    }
    drawRoundedRect(drawX - 14, drawY - 14, 28, 32, 4);
    var bColor = app.currentState === 5 ? '#ef5350' : (app.currentState === 4 ? '#66bb6a' : '#ffa726');
    ctx.fillStyle = bColor + '33';
    ctx.fill();
    ctx.strokeStyle = bColor;
    ctx.lineWidth = 1.5;
    ctx.stroke();
    // ZIP label
    ctx.fillStyle = bColor;
    ctx.font = 'bold 9px sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText('ZIP', drawX, drawY + 3);
    // Zipper lines
    ctx.strokeStyle = bColor + '66';
    ctx.lineWidth = 0.5;
    for (var zi = 0; zi < 3; zi++) {
      ctx.beginPath();
      ctx.moveTo(drawX - 6, drawY - 10 + zi * 6);
      ctx.lineTo(drawX + 6, drawY - 10 + zi * 6);
      ctx.stroke();
    }
    ctx.restore();
    ctx.fillStyle = '#8899aa';
    ctx.font = '10px sans-serif';
    ctx.fillText('Sync Bundle', bx, by + 32);
  }

  // Validation check icon
  if (app.currentState === 2) {
    var vx = W * 0.36, vy = H * 0.25;
    ctx.save();
    ctx.strokeStyle = '#ab47bc';
    ctx.lineWidth = 2.5;
    ctx.beginPath();
    ctx.arc(vx, vy, 14, 0, Math.PI * 2);
    ctx.stroke();
    ctx.strokeStyle = '#ab47bc';
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(vx - 6, vy);
    ctx.lineTo(vx - 1, vy + 6);
    ctx.lineTo(vx + 7, vy - 5);
    ctx.stroke();
    ctx.restore();
  }

  // Queue visualization
  if (app.currentState === 3) {
    var qx = W * 0.56, qy = H * 0.35;
    ctx.save();
    ctx.strokeStyle = '#78909c';
    ctx.lineWidth = 1;
    ctx.setLineDash([3, 3]);
    drawRoundedRect(qx - 24, qy - 16, 48, 36, 4);
    ctx.stroke();
    ctx.setLineDash([]);
    ctx.fillStyle = '#78909c';
    ctx.font = '9px sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText('QUEUE', qx, qy + 32);
    // Clock icon
    ctx.beginPath();
    ctx.arc(qx, qy, 10, 0, Math.PI * 2);
    ctx.strokeStyle = '#78909c';
    ctx.lineWidth = 1.5;
    ctx.stroke();
    // Clock hands
    var angle = t * 2;
    ctx.beginPath();
    ctx.moveTo(qx, qy);
    ctx.lineTo(qx + 6 * Math.cos(angle - Math.PI / 2), qy + 6 * Math.sin(angle - Math.PI / 2));
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(qx, qy);
    ctx.lineTo(qx + 4 * Math.cos(angle * 0.3 - Math.PI / 2), qy + 4 * Math.sin(angle * 0.3 - Math.PI / 2));
    ctx.stroke();
    ctx.restore();
  }

  // Cloud / Server
  var ccx = W * 0.72, ccy = H * 0.28;
  ctx.save();
  // Cloud shape
  ctx.fillStyle = app.online ? 'rgba(102,187,106,0.1)' : 'rgba(239,83,80,0.1)';
  ctx.strokeStyle = app.online ? '#66bb6a' : '#ef5350';
  ctx.lineWidth = 1.5;
  ctx.beginPath();
  ctx.arc(ccx, ccy, 20, Math.PI * 0.9, Math.PI * 0.1);
  ctx.arc(ccx + 16, ccy - 6, 14, Math.PI * 1.2, Math.PI * 0.4);
  ctx.arc(ccx + 20, ccy + 8, 12, Math.PI * 1.6, Math.PI * 0.7);
  ctx.arc(ccx - 16, ccy + 8, 12, Math.PI * 0.3, Math.PI * 1.4);
  ctx.closePath();
  ctx.fill();
  ctx.stroke();
  ctx.fillStyle = '#8899aa';
  ctx.font = '10px sans-serif';
  ctx.textAlign = 'center';
  ctx.fillText('Cloud Server', ccx + 2, ccy + 36);
  ctx.restore();

  // Server / KG endpoint
  var sx = W * 0.88, sy = H * 0.35;
  ctx.save();
  drawRoundedRect(sx - 18, sy - 16, 36, 40, 4);
  ctx.fillStyle = 'rgba(79,195,247,0.1)';
  ctx.fill();
  ctx.strokeStyle = '#4fc3f7';
  ctx.lineWidth = 1.5;
  ctx.stroke();
  // Server lines
  ctx.strokeStyle = 'rgba(79,195,247,0.4)';
  ctx.lineWidth = 0.8;
  for (var si = 0; si < 3; si++) {
    ctx.beginPath();
    ctx.moveTo(sx - 12, sy - 8 + si * 10);
    ctx.lineTo(sx + 12, sy - 8 + si * 10);
    ctx.stroke();
    ctx.beginPath();
    ctx.arc(sx - 8, sy - 5 + si * 10, 2, 0, Math.PI * 2);
    ctx.fillStyle = si === 0 ? '#66bb6a' : (si === 1 ? '#ffa726' : '#42a5f5');
    ctx.fill();
  }
  ctx.fillStyle = '#8899aa';
  ctx.font = '10px sans-serif';
  ctx.textAlign = 'center';
  ctx.fillText('Knowledge', sx, sy + 36);
  ctx.fillText('Graph', sx, sy + 48);
  ctx.restore();

  // Connection line between cloud and server
  ctx.beginPath();
  ctx.moveTo(ccx + 30, ccy + 8);
  ctx.lineTo(sx - 20, sy);
  ctx.strokeStyle = 'rgba(79,195,247,0.15)';
  ctx.lineWidth = 1;
  ctx.setLineDash([3, 3]);
  ctx.stroke();
  ctx.setLineDash([]);

  // Animated particles along the path when syncing
  if (app.currentState === 3 || app.currentState === 4) {
    drawParticles(t, W, H);
  }

  // Offline overlay
  if (!app.online) {
    ctx.save();
    ctx.fillStyle = 'rgba(239,83,80,0.06)';
    ctx.fillRect(W * 0.5, 0, W * 0.5, H);
    // "No Signal" text
    ctx.fillStyle = 'rgba(239,83,80,0.5)';
    ctx.font = 'bold 12px sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText('NO NETWORK', W * 0.72, H * 0.75);
    // Diagonal lines
    ctx.strokeStyle = 'rgba(239,83,80,0.08)';
    ctx.lineWidth = 1;
    for (var di = -10; di < 20; di++) {
      ctx.beginPath();
      ctx.moveTo(W * 0.5 + di * 30, 0);
      ctx.lineTo(W * 0.5 + di * 30 - H * 0.5, H);
      ctx.stroke();
    }
    ctx.restore();
  }

  // Backoff countdown visualization
  if (app.backoffRemaining > 0 && app.currentState === 5) {
    var bkx = W * 0.56, bky = H * 0.2;
    ctx.save();
    ctx.fillStyle = 'rgba(255,167,38,0.1)';
    ctx.beginPath();
    ctx.arc(bkx, bky, 24, 0, Math.PI * 2);
    ctx.fill();
    ctx.strokeStyle = '#ffa726';
    ctx.lineWidth = 2;
    // Arc showing remaining
    var total = BACKOFF_INTERVALS[app.backoffIndex] || 30;
    var frac = app.backoffRemaining / total;
    ctx.beginPath();
    ctx.arc(bkx, bky, 24, -Math.PI / 2, -Math.PI / 2 + Math.PI * 2 * frac);
    ctx.stroke();
    ctx.fillStyle = '#ffa726';
    ctx.font = 'bold 14px sans-serif';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText(app.backoffRemaining + 's', bkx, bky);
    ctx.textBaseline = 'alphabetic';
    ctx.font = '9px sans-serif';
    ctx.fillText('BACKOFF', bkx, bky + 38);
    ctx.restore();
  }

  // Success celebration effect
  if (app.currentState === 4) {
    ctx.save();
    var sparkles = 8;
    for (var sp = 0; sp < sparkles; sp++) {
      var sa = (Math.PI * 2 / sparkles) * sp + t * 0.5;
      var sr = 30 + 10 * Math.sin(t * 3 + sp);
      var spx = ccx + Math.cos(sa) * sr;
      var spy = ccy + Math.sin(sa) * sr;
      ctx.fillStyle = 'rgba(102,187,106,' + (0.3 + 0.3 * Math.sin(t * 4 + sp)) + ')';
      ctx.beginPath();
      ctx.arc(spx, spy, 2, 0, Math.PI * 2);
      ctx.fill();
    }
    ctx.restore();
  }

  // Error X effect
  if (app.currentState === 5) {
    ctx.save();
    var ex = ccx, ey = ccy;
    ctx.strokeStyle = 'rgba(239,83,80,' + (0.3 + 0.3 * Math.sin(t * 5)) + ')';
    ctx.lineWidth = 3;
    ctx.beginPath(); ctx.moveTo(ex - 10, ey - 10); ctx.lineTo(ex + 10, ey + 10); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(ex + 10, ey - 10); ctx.lineTo(ex - 10, ey + 10); ctx.stroke();
    ctx.restore();
  }
}

function drawParticles(t, W, H) {
  var fromX = W * 0.48, fromY = H * 0.42;
  var toX = W * 0.70, toY = H * 0.30;
  var count = 5;
  for (var i = 0; i < count; i++) {
    var p = ((t * 0.4 + i / count) % 1);
    var px = fromX + (toX - fromX) * p;
    var py = fromY + (toY - fromY) * p - 10 * Math.sin(p * Math.PI);
    var alpha = p < 0.1 ? p / 0.1 : (p > 0.9 ? (1 - p) / 0.1 : 1);
    ctx.fillStyle = 'rgba(79,195,247,' + (alpha * 0.8) + ')';
    ctx.beginPath();
    ctx.arc(px, py, 2.5, 0, Math.PI * 2);
    ctx.fill();
  }
}

// ===================================================================
// Knowledge Graph SVG (Scenario 4)
// ===================================================================

function buildKGSvg() {
  var svg = getEl('kgSvg');
  svg.innerHTML =
    '<defs>' +
      '<filter id="kgGlow">' +
        '<feGaussianBlur stdDeviation="4" result="blur"/>' +
        '<feMerge><feMergeNode in="blur"/><feMergeNode in="SourceGraphic"/></feMerge>' +
      '</filter>' +
      '<marker id="kgArrow" markerWidth="6" markerHeight="4" refX="6" refY="2" orient="auto">' +
        '<polygon points="0 0, 6 2, 0 4" fill="#4fc3f7" opacity="0.5"/>' +
      '</marker>' +
    '</defs>' +

    '<!-- Central KG node -->' +
    '<circle cx="350" cy="200" r="50" fill="rgba(79,195,247,0.1)" stroke="#4fc3f7" stroke-width="2" id="kgCenter"/>' +
    '<text x="350" y="195" text-anchor="middle" fill="#4fc3f7" font-size="12" font-weight="bold">Knowledge</text>' +
    '<text x="350" y="210" text-anchor="middle" fill="#4fc3f7" font-size="12" font-weight="bold">Graph</text>' +

    '<!-- Source nodes -->' +
    '<g class="kg-source" id="kgPyarchinit" opacity="0.2">' +
      '<line x1="172" y1="96" x2="308" y2="170" stroke="#42a5f5" stroke-width="1.5" marker-end="url(#kgArrow)" stroke-dasharray="4,3"/>' +
      '<circle cx="140" cy="80" r="34" fill="rgba(66,165,245,0.1)" stroke="#42a5f5" stroke-width="1.5"/>' +
      '<text x="140" y="76" text-anchor="middle" fill="#42a5f5" font-size="9" font-weight="bold">PyArchInit</text>' +
      '<text x="140" y="90" text-anchor="middle" fill="#8899aa" font-size="8">Stratigraphy</text>' +
    '</g>' +
    '<g class="kg-source" id="kgGis" opacity="0.2">' +
      '<line x1="148" y1="228" x2="300" y2="208" stroke="#ffa726" stroke-width="1.5" marker-end="url(#kgArrow)" stroke-dasharray="4,3"/>' +
      '<circle cx="115" cy="235" r="34" fill="rgba(255,167,38,0.1)" stroke="#ffa726" stroke-width="1.5"/>' +
      '<text x="115" y="231" text-anchor="middle" fill="#ffa726" font-size="9" font-weight="bold">GIS</text>' +
      '<text x="115" y="245" text-anchor="middle" fill="#8899aa" font-size="8">Spatial Data</text>' +
    '</g>' +
    '<g class="kg-source" id="kgPhoto" opacity="0.2">' +
      '<line x1="195" y1="342" x2="318" y2="240" stroke="#ab47bc" stroke-width="1.5" marker-end="url(#kgArrow)" stroke-dasharray="4,3"/>' +
      '<circle cx="170" cy="360" r="34" fill="rgba(171,71,188,0.1)" stroke="#ab47bc" stroke-width="1.5"/>' +
      '<text x="170" y="356" text-anchor="middle" fill="#ab47bc" font-size="9" font-weight="bold">Photogramm.</text>' +
      '<text x="170" y="370" text-anchor="middle" fill="#8899aa" font-size="8">3D Models</text>' +
    '</g>' +
    '<g class="kg-source" id="kgFinds" opacity="0.2">' +
      '<line x1="528" y1="96" x2="392" y2="170" stroke="#66bb6a" stroke-width="1.5" marker-end="url(#kgArrow)" stroke-dasharray="4,3"/>' +
      '<circle cx="560" cy="80" r="34" fill="rgba(102,187,106,0.1)" stroke="#66bb6a" stroke-width="1.5"/>' +
      '<text x="560" y="76" text-anchor="middle" fill="#66bb6a" font-size="9" font-weight="bold">Finds DB</text>' +
      '<text x="560" y="90" text-anchor="middle" fill="#8899aa" font-size="8">Artifacts</text>' +
    '</g>' +
    '<g class="kg-source" id="kgEnv" opacity="0.2">' +
      '<line x1="552" y1="228" x2="400" y2="208" stroke="#ef5350" stroke-width="1.5" marker-end="url(#kgArrow)" stroke-dasharray="4,3"/>' +
      '<circle cx="585" cy="235" r="34" fill="rgba(239,83,80,0.1)" stroke="#ef5350" stroke-width="1.5"/>' +
      '<text x="585" y="231" text-anchor="middle" fill="#ef5350" font-size="9" font-weight="bold">Env. Analysis</text>' +
      '<text x="585" y="245" text-anchor="middle" fill="#8899aa" font-size="8">Dating / Env</text>' +
    '</g>' +

    '<!-- Query result indicator -->' +
    '<g id="kgQuery" opacity="0">' +
      '<rect x="270" y="280" width="160" height="40" rx="6" fill="rgba(79,195,247,0.1)" stroke="#4fc3f7" stroke-width="1" stroke-dasharray="4,3"/>' +
      '<text x="350" y="302" text-anchor="middle" fill="#4fc3f7" font-size="10">&#128269; Cross-project Query</text>' +
    '</g>';
}

function updateKG(step) {
  if (!step || !step.kg) return;
  var kgMap = {
    'pyarchinit': 'kgPyarchinit',
    'gis': 'kgGis',
    'photo': 'kgPhoto',
    'finds': 'kgFinds',
    'env': 'kgEnv'
  };
  var kgKeys, kk, kid, kel;
  if (step.kg === 'init') {
    // Reset all to dim
    kgKeys = ['pyarchinit', 'gis', 'photo', 'finds', 'env'];
    for (kk = 0; kk < kgKeys.length; kk++) {
      kid = kgMap[kgKeys[kk]];
      kel = getEl(kid);
      if (kel) kel.setAttribute('opacity', '0.2');
    }
    getEl('kgQuery').setAttribute('opacity', '0');
    getEl('kgCenter').setAttribute('stroke-width', '2');
  } else if (step.kg === 'all') {
    kgKeys = ['pyarchinit', 'gis', 'photo', 'finds', 'env'];
    for (kk = 0; kk < kgKeys.length; kk++) {
      kid = kgMap[kgKeys[kk]];
      kel = getEl(kid);
      if (kel) {
        kel.setAttribute('opacity', '1');
      }
    }
    getEl('kgCenter').setAttribute('stroke-width', '3');
    getEl('kgCenter').setAttribute('filter', 'url(#kgGlow)');
  } else if (step.kg === 'query') {
    getEl('kgQuery').setAttribute('opacity', '1');
  } else if (kgMap[step.kg]) {
    kel = getEl(kgMap[step.kg]);
    if (kel) kel.setAttribute('opacity', '1');
  }
}

// ===================================================================
// Animation / Step Engine
// ===================================================================

function loadScenario(index) {
  app.scenario = index;
  app.currentStep = 0;
  app.steps = SCENARIOS[index].steps;
  app.queueCount = 0;
  app.syncedCount = 0;
  app.failedCount = 0;
  app.backoffIndex = -1;
  app.backoffRemaining = 0;
  app.bundlePos = null;

  clearTimeout(app.pendingStepTimer);
  app.pendingStepTimer = null;

  // Reset UI
  updateQueueCount(0);
  getEl('syncedCount').textContent = '0';
  app.syncedCount = 0;
  getEl('failedCount').textContent = '0';
  app.failedCount = 0;
  updateBackoff(-1, 0);
  updateConnectivity(true);
  var firstState = (app.steps[0] && app.steps[0].state !== undefined) ? app.steps[0].state : 0;
  updateCurrentState(firstState);
  logEntries.innerHTML = '';
  app.logCounter = 0;
  updateStepIndicator();
  updateScenarioDesc(SCENARIOS[index].description);

  // KG overlay
  if (index === 3) {
    // Add 'visible' class
    var kgCls = kgOverlay.className || '';
    if (kgCls.indexOf('visible') === -1) {
      kgOverlay.className = kgCls + ' visible';
    }
    buildKGSvg();
  } else {
    // Remove 'visible' class
    var kgCls2 = kgOverlay.className || '';
    kgOverlay.className = kgCls2.replace(/\s*visible/g, '');
  }

  // Auto-play first step
  executeStep(0);
}

function executeStep(stepIndex) {
  if (stepIndex < 0 || stepIndex >= app.steps.length) return;
  app.currentStep = stepIndex;
  var step = app.steps[stepIndex];

  // Apply step effects
  updateConnectivity(step.online);
  if (step.state >= 0) updateCurrentState(step.state);
  else updateCurrentState(-1);
  addLogEntry(step.log, step.type);
  if (step.queue !== undefined) updateQueueCount(step.queue);
  if (step.synced) updateSyncedCount(step.synced);
  if (step.failed) updateFailedCount(step.failed);
  if (step.backoff !== undefined) {
    updateBackoff(step.backoff, BACKOFF_INTERVALS[step.backoff]);
  } else if (step.state !== 5) {
    updateBackoff(-1, 0);
  }
  if (step.desc) {
    var stateLabel = step.state >= 0 ? STATE_NAMES[step.state] : STATE_NAMES[0];
    updateScenarioDesc('<strong>' + stateLabel + ':</strong> ' + step.desc);
  }
  if (step.kg) updateKG(step);

  // Update bundle position for scene
  if (step.state >= 1 && step.state <= 4) {
    var bW = canvas.width;
    var bH = canvas.height;
    var positions = [
      null,
      {x: bW * 0.30, y: bH * 0.38},
      {x: bW * 0.38, y: bH * 0.38},
      {x: bW * 0.50, y: bH * 0.38},
      {x: bW * 0.65, y: bH * 0.32}
    ];
    app.bundlePos = positions[step.state] || null;
  } else if (step.state === 5) {
    var bW2 = canvas.width;
    var bH2 = canvas.height;
    app.bundlePos = {x: bW2 * 0.56, y: bH2 * 0.42};
  } else {
    app.bundlePos = null;
  }

  // Debounce fill animation
  if (step.log && step.log.indexOf('check 1/2') !== -1) {
    getEl('debounceFill').style.width = '50%';
    getEl('debounceText').textContent = 'Debounce: check 1/2';
  } else if (step.log && step.log.indexOf('check 2/2') !== -1) {
    getEl('debounceFill').style.width = '100%';
    getEl('debounceText').textContent = 'Debounce: check 2/2 — CONFIRMED';
  } else if (step.log && step.log.indexOf('Debounce passed') !== -1) {
    getEl('debounceFill').style.width = '100%';
    getEl('debounceText').textContent = 'Debounce: PASSED';
  } else {
    getEl('debounceFill').style.width = '0%';
    getEl('debounceText').textContent = 'Debounce: 2 consecutive checks';
  }

  updateStepIndicator();

  // Schedule next step in auto mode
  if (app.mode === 'auto' && app.playing) {
    scheduleNextStep();
  }
}

function scheduleNextStep() {
  clearTimeout(app.pendingStepTimer);

  var isLastStep = app.currentStep >= app.steps.length - 1;

  // If last step and looping, schedule transition to next scenario
  if (isLastStep && app.looping) {
    var nextScenario = (app.scenario + 1) % SCENARIOS.length;
    var transDelay = 3000 / app.speed;
    app.pendingStepTimer = setTimeout(function() {
      if (app.playing && app.mode === 'auto' && app.looping) {
        addLogEntry('--- Advancing to scenario: ' + SCENARIOS[nextScenario].title + ' ---', 'info');
        scenarioSelect.value = nextScenario;
        loadScenario(nextScenario);
      }
    }, transDelay);
    return;
  }

  if (isLastStep) return;

  // Base delay depends on step type
  var step = app.steps[app.currentStep];
  var delay = 2000; // base 2s per step
  if (step.backoff !== undefined) delay = 3500; // longer for backoff
  if (step.type === 'success') delay = 2500;
  if (app.scenario === 3) delay = 2500; // KG needs reading time

  delay = delay / app.speed;

  app.pendingStepTimer = setTimeout(function() {
    if (app.playing && app.mode === 'auto') {
      executeStep(app.currentStep + 1);
    }
  }, delay);
}

function nextStep() {
  if (app.currentStep < app.steps.length - 1) {
    executeStep(app.currentStep + 1);
  }
}

function prevStep() {
  if (app.currentStep > 0) {
    // Re-run from beginning up to previous step to rebuild state
    var target = app.currentStep - 1;
    resetState();
    for (var i = 0; i <= target; i++) {
      var s = app.steps[i];
      if (s.online !== undefined) app.online = s.online;
      if (s.queue !== undefined) app.queueCount = s.queue;
    }
    executeStep(target);
  }
}

function resetState() {
  app.queueCount = 0;
  app.syncedCount = 0;
  app.failedCount = 0;
  getEl('syncedCount').textContent = '0';
  getEl('failedCount').textContent = '0';
  logEntries.innerHTML = '';
  app.logCounter = 0;
  updateBackoff(-1, 0);
}

// ===================================================================
// Render Loop
// ===================================================================

function renderLoop(timestamp) {
  if (!app.lastTimestamp) app.lastTimestamp = timestamp;
  app.animationTime = timestamp;
  drawScene(timestamp);
  requestAnimationFrame(renderLoop);
}

// ===================================================================
// Event Bindings
// ===================================================================

scenarioSelect.addEventListener('change', function() {
  loadScenario(parseInt(scenarioSelect.value, 10));
});

btnAuto.addEventListener('click', function() {
  app.mode = 'auto';
  btnAuto.className = 'active';
  btnManual.className = '';
  btnPrev.disabled = true;
  btnNext.disabled = true;
  if (app.playing) scheduleNextStep();
});

btnManual.addEventListener('click', function() {
  app.mode = 'manual';
  btnManual.className = 'active';
  btnAuto.className = '';
  btnPrev.disabled = false;
  btnNext.disabled = false;
  clearTimeout(app.pendingStepTimer);
});

btnPlayPause.addEventListener('click', function() {
  app.playing = !app.playing;
  btnPlayPause.innerHTML = app.playing ? '&#10074;&#10074; Pause' : '&#9654; Play';
  if (app.playing && app.mode === 'auto') scheduleNextStep();
  else clearTimeout(app.pendingStepTimer);
});

btnPrev.addEventListener('click', function() { prevStep(); });
btnNext.addEventListener('click', function() { nextStep(); });

btnRestart.addEventListener('click', function() {
  app.playing = true;
  btnPlayPause.innerHTML = '&#10074;&#10074; Pause';
  loadScenario(app.scenario);
});

for (var sbi = 0; sbi < speedBtns.length; sbi++) {
  (function(btn) {
    btn.addEventListener('click', function() {
      for (var j = 0; j < speedBtns.length; j++) {
        speedBtns[j].className = 'speed-btn';
      }
      btn.className = 'speed-btn active';
      app.speed = parseInt(btn.getAttribute('data-speed'), 10);
      // Re-schedule if auto-playing
      if (app.playing && app.mode === 'auto') scheduleNextStep();
    });
  })(speedBtns[sbi]);
}

btnLoop.addEventListener('click', function() {
  app.looping = !app.looping;
  if (app.looping) {
    // Add active class
    var cls = btnLoop.className || '';
    if (cls.indexOf('active') === -1) {
      btnLoop.className = cls + ' active';
    }
  } else {
    // Remove active class
    var cls2 = btnLoop.className || '';
    btnLoop.className = cls2.replace(/\s*active/g, '');
  }
  btnStop.style.display = app.looping ? '' : 'none';
  if (app.looping) {
    btnLoop.innerHTML = '&#8635; Looping';
    // If we're at the last step and auto-playing, schedule next scenario
    if (app.playing && app.mode === 'auto' && app.currentStep >= app.steps.length - 1) {
      scheduleNextStep();
    }
  } else {
    btnLoop.innerHTML = '&#8635; Loop';
  }
});

btnStop.addEventListener('click', function() {
  app.looping = false;
  app.playing = false;
  btnLoop.className = (btnLoop.className || '').replace(/\s*active/g, '');
  btnLoop.innerHTML = '&#8635; Loop';
  btnStop.style.display = 'none';
  btnPlayPause.innerHTML = '&#9654; Play';
  clearTimeout(app.pendingStepTimer);
  addLogEntry('Loop stopped by user.', 'warning');
});

// Keyboard controls
document.addEventListener('keydown', function(e) {
  if (e.key === ' ') { e.preventDefault(); btnPlayPause.click(); }
  if (e.key === 'ArrowRight' && app.mode === 'manual') nextStep();
  if (e.key === 'ArrowLeft' && app.mode === 'manual') prevStep();
  if (e.key === 'r' || e.key === 'R') btnRestart.click();
  if (e.key === 'l' || e.key === 'L') btnLoop.click();
  if (e.key === 's' || e.key === 'S') { if (app.looping) btnStop.click(); }
  if (e.key >= '1' && e.key <= '4') {
    scenarioSelect.value = parseInt(e.key, 10) - 1;
    loadScenario(parseInt(e.key, 10) - 1);
  }
});

// Resize handler
window.addEventListener('resize', function() { resizeCanvas(); });

// ===================================================================
// Init
// ===================================================================

resizeCanvas();
buildKGSvg();
requestAnimationFrame(renderLoop);
loadScenario(0);

})();
</script>
</body>
</html>
