# الدرس 19: العمل متعدد المستخدمين مع PostgreSQL

## المقدمة

يدعم PyArchInit العمل **متعدد المستخدمين** من خلال استخدام **PostgreSQL/PostGIS** كخلفية لقاعدة البيانات. يتيح هذا التكوين لعدة مشغلين العمل في نفس الوقت على نفس المشروع الأثري من محطات عمل مختلفة.

### مزايا تعدد المستخدمين

| الجانب | SQLite | PostgreSQL متعدد المستخدمين |
|--------|--------|---------------------------|
| المستخدمون المتزامنون | 1 | غير محدود |
| الوصول عن بُعد | لا | نعم |
| إدارة الأذونات | لا | نعم |
| النسخ الاحتياطي المركزي | يدوي | قابل للأتمتة |
| الأداء | جيد | ممتاز |
| قابلية التوسع | محدودة | عالية |

## المتطلبات المسبقة

### الخادم

1. **PostgreSQL** 12 أو أعلى
2. **PostGIS** 3.0 أو أعلى
3. خادم قابل للوصول عبر الشبكة (LAN أو الإنترنت)

### العميل

1. QGIS مع تثبيت PyArchInit
2. اتصال شبكة بالخادم
3. بيانات اعتماد الوصول

## تكوين الخادم

### تثبيت PostgreSQL

#### Ubuntu/Debian
```bash
sudo apt update
sudo apt install postgresql postgresql-contrib postgis
```

#### Windows
- تنزيل المُثبت من [postgresql.org](https://www.postgresql.org/download/windows/)
- التثبيت مع Stack Builder لـ PostGIS

#### macOS
```bash
brew install postgresql postgis
brew services start postgresql
```

### إنشاء قاعدة البيانات

```sql
-- الاتصال كمستخدم خارق
sudo -u postgres psql

-- إنشاء قاعدة البيانات
CREATE DATABASE pyarchinit_db;

-- تفعيل PostGIS
\c pyarchinit_db
CREATE EXTENSION postgis;
CREATE EXTENSION postgis_topology;

-- إنشاء مستخدم التطبيق
CREATE USER pyarchinit WITH PASSWORD 'كلمة_مرور_آمنة';
GRANT ALL PRIVILEGES ON DATABASE pyarchinit_db TO pyarchinit;
```

### تكوين الوصول الشبكي

تعديل `pg_hba.conf`:
```
# السماح بالاتصالات من الشبكة المحلية
host    pyarchinit_db    pyarchinit    192.168.1.0/24    md5

# أو من أي IP (أقل أماناً)
host    pyarchinit_db    pyarchinit    0.0.0.0/0    md5
```

تعديل `postgresql.conf`:
```
listen_addresses = '*'
```

إعادة تشغيل PostgreSQL:
```bash
sudo systemctl restart postgresql
```

## تكوين عميل PyArchInit

### الإعداد الأولي

1. **PyArchInit** ← **التكوين**
2. تبويب **قاعدة البيانات**
3. اختيار **PostgreSQL**
4. ملء الحقول:

| الحقل | القيمة |
|-------|--------|
| الخادم | عنوان IP أو اسم المضيف |
| المنفذ | 5432 (افتراضي) |
| قاعدة البيانات | pyarchinit_db |
| المستخدم | pyarchinit |
| كلمة المرور | كلمة_مرور_آمنة |

### اختبار الاتصال

1. النقر على **اختبار الاتصال**
2. التحقق من رسالة النجاح
3. حفظ التكوين

### إنشاء المخطط

إذا كانت قاعدة البيانات جديدة:
1. النقر على **إنشاء المخطط**
2. انتظار إنشاء الجداول
3. التحقق من البنية

## إدارة المستخدمين

### إنشاء مستخدمين إضافيين

```sql
-- مستخدم بوصول كامل
CREATE USER archaeologist1 WITH PASSWORD 'password1';
GRANT ALL ON ALL TABLES IN SCHEMA public TO archaeologist1;
GRANT ALL ON ALL SEQUENCES IN SCHEMA public TO archaeologist1;

-- مستخدم للقراءة فقط
CREATE USER consultant1 WITH PASSWORD 'password2';
GRANT SELECT ON ALL TABLES IN SCHEMA public TO consultant1;
```

### مستويات الوصول المقترحة

| الدور | الأذونات | الاستخدام |
|-------|----------|----------|
| مسؤول | ALL | التكوين، الإدارة |
| عالم آثار | SELECT, INSERT, UPDATE, DELETE | العمل اليومي |
| متخصص | SELECT, INSERT, UPDATE (جداول محددة) | إدخال بيانات متخصصة |
| مستشار | SELECT | استشارة البيانات |
| نسخ احتياطي | SELECT | سكريبتات النسخ الاحتياطي |

### إدارة الأدوار

```sql
-- إنشاء دور مجموعة
CREATE ROLE archaeologists;
GRANT SELECT, INSERT, UPDATE, DELETE ON ALL TABLES IN SCHEMA public TO archaeologists;

-- تعيين المستخدمين للمجموعة
GRANT archaeologists TO archaeologist1;
GRANT archaeologists TO archaeologist2;
```

## سير العمل متعدد المستخدمين

### تنظيم العمل

#### حسب المنطقة
- تعيين مناطق مختلفة لمشغلين مختلفين
- تجنب التداخلات

#### حسب النمط
- مشغل: وحدات طبقية ترسب
- مشغل آخر: وحدات جدارية
- مشغل آخر: القطع

#### حسب الموقع
- مواقع مختلفة لفرق مختلفة

### إدارة التعارضات

#### قفل السجل (موصى به)
1. قبل التعديل، التحقق من عدم عمل أحد على نفس السجل
2. التواصل مع الفريق

#### حل التعارضات
في حالة التعديلات المتزامنة:
1. التعديل الأخير يسود
2. التحقق من البيانات بعد كل جلسة
3. استخدام حقل "تاريخ التعديل" للتتبع

### المزامنة

مع PostgreSQL المزامنة تلقائية:
- كل تعديل مرئي فوراً للآخرين
- لا حاجة لمزامنة يدوية
- تحديث البطاقة لرؤية التحديثات

## النسخ الاحتياطي والأمان

### النسخ الاحتياطي التلقائي

سكريبت نسخ احتياطي يومي:
```bash
#!/bin/bash
# backup_pyarchinit.sh
DATE=$(date +%Y%m%d)
BACKUP_DIR=/var/backups/pyarchinit
pg_dump -U pyarchinit -h localhost pyarchinit_db > $BACKUP_DIR/backup_$DATE.sql
gzip $BACKUP_DIR/backup_$DATE.sql

# الاحتفاظ بآخر 30 يوماً فقط
find $BACKUP_DIR -name "*.gz" -mtime +30 -delete
```

جدولة مع cron:
```bash
# crontab -e
0 2 * * * /path/to/backup_pyarchinit.sh
```

### الاستعادة

```bash
# الاستعادة من النسخ الاحتياطي
gunzip backup_20260114.sql.gz
psql -U pyarchinit -h localhost pyarchinit_db < backup_20260114.sql
```

### الأمان

1. **كلمات مرور قوية**: 12 حرفاً كحد أدنى، مزيج من الأحرف الكبيرة/الصغيرة/الأرقام
2. **اتصالات SSL**: تفعيل SSL للاتصالات عن بُعد
3. **جدار الحماية**: تقييد الوصول للمنفذ 5432
4. **التحديثات**: إبقاء PostgreSQL محدثاً
5. **سجل التدقيق**: تفعيل تسجيل الاتصالات

### SSL للاتصالات عن بُعد

في `postgresql.conf`:
```
ssl = on
ssl_cert_file = 'server.crt'
ssl_key_file = 'server.key'
```

في `pg_hba.conf`:
```
hostssl    pyarchinit_db    pyarchinit    0.0.0.0/0    md5
```

## المراقبة

### الاتصالات النشطة

```sql
SELECT
    usename,
    client_addr,
    state,
    query_start,
    query
FROM pg_stat_activity
WHERE datname = 'pyarchinit_db';
```

### حجم قاعدة البيانات

```sql
SELECT pg_size_pretty(pg_database_size('pyarchinit_db'));
```

### الأقفال النشطة

```sql
SELECT
    l.locktype,
    l.relation::regclass,
    l.mode,
    l.granted,
    a.usename,
    a.query
FROM pg_locks l
JOIN pg_stat_activity a ON l.pid = a.pid
WHERE l.database = (SELECT oid FROM pg_database WHERE datname = 'pyarchinit_db');
```

## الترحيل من SQLite

### التصدير من SQLite

1. فتح PyArchInit مع قاعدة بيانات SQLite
2. **PyArchInit** ← **الأدوات** ← **تصدير قاعدة البيانات**
3. التصدير بصيغة SQL

### الاستيراد في PostgreSQL

1. تكوين اتصال PostgreSQL
2. إنشاء مخطط فارغ
3. استيراد البيانات المُصدرة

## أفضل الممارسات

### 1. التخطيط

- تحديد الأدوار والمسؤوليات
- وضع اتفاقيات العمل
- توثيق الإجراءات

### 2. التواصل

- قناة تواصل للفريق (دردشة، بريد إلكتروني)
- الإشارة إلى بداية/نهاية جلسات العمل
- إبلاغ المناطق قيد التعديل

### 3. النسخ الاحتياطي

- نسخ احتياطية يومية تلقائية
- اختبار دوري للاستعادة
- نسخ احتياطي خارج الموقع

### 4. التدريب

- تدريب على سير العمل متعدد المستخدمين
- توثيق الإجراءات
- توفر الدعم التقني

## حل المشكلات

### رفض الاتصال

**الأسباب**:
- الخادم غير قابل للوصول
- جدار الحماية يحظر
- بيانات الاعتماد خاطئة

**الحلول**:
- التحقق من اتصال الشبكة
- فحص قواعد جدار الحماية
- التحقق من بيانات الاعتماد

### انتهاء مهلة الاتصال

**الأسباب**:
- شبكة بطيئة
- خادم مثقل
- اتصالات كثيرة جداً

**الحلول**:
- تحسين الشبكة
- زيادة موارد الخادم
- تحديد الاتصالات المتزامنة

### قفل قاعدة البيانات

**السبب**: معاملات غير مكتملة

**الحل**:
```sql
-- تحديد العمليات الحاظرة
SELECT * FROM pg_locks WHERE NOT granted;

-- إنهاء العملية (بحذر)
SELECT pg_terminate_backend(pid);
```

## المراجع

### التكوين
- `modules/db/pyarchinit_conn_strings.py` - سلاسل الاتصال
- `gui/pyarchinit_Setting.py` - واجهة التكوين

### التوثيق الخارجي
- [PostgreSQL Documentation](https://www.postgresql.org/docs/)
- [PostGIS Documentation](https://postgis.net/documentation/)

---

## فيديوهات تعليمية

### إعداد تعدد المستخدمين
`[فيديو مؤقت: video_multiutente_setup.mp4]`

**المحتويات**:
- تثبيت PostgreSQL
- تكوين الخادم
- إعداد العميل
- إدارة المستخدمين

**المدة المتوقعة**: 20-25 دقيقة

### سير العمل التعاوني
`[فيديو مؤقت: video_multiutente_workflow.mp4]`

**المحتويات**:
- تنظيم العمل
- إدارة التعارضات
- أفضل الممارسات

**المدة المتوقعة**: 12-15 دقيقة

---

*آخر تحديث: يناير 2026*

---

## رسوم متحركة تفاعلية

استكشف الرسوم المتحركة التفاعلية لمعرفة المزيد حول هذا الموضوع.

[افتح الرسوم المتحركة التفاعلية](../animations/pyarchinit_concurrency_animation.html)
