# الدرس 18: النسخ الاحتياطي والاستعادة

## المقدمة

إدارة **النسخ الاحتياطي** أساسية لأمان البيانات الأثرية. يوفر PyArchInit أدوات لتنفيذ نسخ احتياطي لقاعدة البيانات والملفات المرتبطة، سواء لـ SQLite أو PostgreSQL.

### أهمية النسخ الاحتياطي

- **حماية البيانات**: الحماية من الفقدان العرضي
- **الإصدارات**: إمكانية العودة إلى حالات سابقة
- **الترحيل**: النقل بين الأنظمة
- **الأرشفة**: حفظ المشاريع المكتملة

---

## أنواع النسخ الاحتياطي

### نسخ احتياطي لقاعدة بيانات SQLite

لقواعد بيانات SQLite (ملفات `.sqlite`):
- نسخ مباشر لملف قاعدة البيانات
- بسيط وسريع
- يشمل جميع البيانات

### نسخ احتياطي لقاعدة بيانات PostgreSQL

لقواعد بيانات PostgreSQL:
- تصدير عبر `pg_dump`
- صيغة SQL أو مخصصة
- يمكن أن يشمل المخطط و/أو البيانات

### نسخ احتياطي كامل

يشمل:
- قاعدة البيانات
- ملفات الوسائط (صور، فيديو)
- ملفات التكوين
- التقارير المُنشأة

---

## الوصول إلى وظائف النسخ الاحتياطي

### عبر لوحة التكوين

1. قائمة **PyArchInit** > **SketchGPT** > **الإعدادات** (أو الإعدادات مباشرة)
2. في نافذة التكوين
3. تبويب أو قسم مخصص للنسخ الاحتياطي

### عبر نظام الملفات

لـ SQLite، يمكن النسخ مباشرة:
```
[PYARCHINIT_HOME]/pyarchinit_DB_folder/pyarchinit_db.sqlite
```

---

## النسخ الاحتياطي لـ SQLite

### الإجراء اليدوي

1. **إغلاق** جميع بطاقات PyArchInit المفتوحة
2. **تحديد** ملف قاعدة البيانات:
   ```
   ~/pyarchinit/pyarchinit_DB_folder/pyarchinit_db.sqlite
   ```
   على Windows:
   ```
   C:\Users\[المستخدم]\pyarchinit\pyarchinit_DB_folder\pyarchinit_db.sqlite
   ```

3. **نسخ** الملف إلى مجلد النسخ الاحتياطي:
   ```
   pyarchinit_db_backup_2024-01-15.sqlite
   ```

4. **التحقق** من السلامة بفتح النسخة بأداة SQLite

### سكريبت تلقائي (اختياري)

للنسخ الاحتياطي التلقائي، إنشاء سكريبت:

**Linux/Mac (bash):**
```bash
#!/bin/bash
DATE=$(date +%Y%m%d_%H%M%S)
SOURCE=~/pyarchinit/pyarchinit_DB_folder/pyarchinit_db.sqlite
DEST=~/pyarchinit_backups/pyarchinit_db_$DATE.sqlite
cp "$SOURCE" "$DEST"
echo "اكتمل النسخ الاحتياطي: $DEST"
```

**Windows (batch):**
```batch
@echo off
set DATE=%date:~-4%%date:~3,2%%date:~0,2%_%time:~0,2%%time:~3,2%
set SOURCE=%USERPROFILE%\pyarchinit\pyarchinit_DB_folder\pyarchinit_db.sqlite
set DEST=%USERPROFILE%\pyarchinit_backups\pyarchinit_db_%DATE%.sqlite
copy "%SOURCE%" "%DEST%"
echo اكتمل النسخ الاحتياطي: %DEST%
```

---

## النسخ الاحتياطي لـ PostgreSQL

### باستخدام pg_dump

1. **فتح** طرفية/موجه أوامر

2. **تنفيذ** pg_dump:
   ```bash
   pg_dump -h localhost -U postgres -d pyarchinit -F c -f backup_pyarchinit.dump
   ```

   المعاملات:
   - `-h`: مضيف قاعدة البيانات
   - `-U`: المستخدم
   - `-d`: اسم قاعدة البيانات
   - `-F c`: صيغة مخصصة (مضغوطة)
   - `-f`: ملف المخرجات

3. **إدخال** كلمة المرور عند الطلب

### نسخ احتياطي للبيانات فقط

```bash
pg_dump -h localhost -U postgres -d pyarchinit --data-only -f backup_dati.sql
```

### نسخ احتياطي للمخطط فقط

```bash
pg_dump -h localhost -U postgres -d pyarchinit --schema-only -f backup_schema.sql
```

---

## النسخ الاحتياطي لملفات الوسائط

### مجلد الوسائط

ملفات الوسائط موجودة في المجلد:
```
[PYARCHINIT_HOME]/pyarchinit_image_folder/
```

### الإجراء

1. **تحديد** المجلد:
   ```
   ~/pyarchinit/pyarchinit_image_folder/
   ```

2. **نسخ** المجلد بالكامل:
   ```bash
   cp -r ~/pyarchinit/pyarchinit_image_folder ~/backup/pyarchinit_media_backup/
   ```

3. **ضغط** (اختياري):
   ```bash
   tar -czvf pyarchinit_media_backup.tar.gz ~/pyarchinit/pyarchinit_image_folder/
   ```

---

## الاستعادة

### استعادة SQLite

1. **إغلاق** QGIS وPyArchInit
2. **إعادة تسمية** قاعدة البيانات الحالية (للأمان):
   ```bash
   mv pyarchinit_db.sqlite pyarchinit_db_old.sqlite
   ```
3. **نسخ** النسخة الاحتياطية إلى المجلد الأصلي:
   ```bash
   cp backup/pyarchinit_db_backup.sqlite pyarchinit_DB_folder/pyarchinit_db.sqlite
   ```
4. **إعادة تشغيل** QGIS

### استعادة PostgreSQL

1. **إنشاء** قاعدة بيانات فارغة (إذا لزم الأمر):
   ```bash
   createdb -U postgres pyarchinit_restored
   ```

2. **استعادة** النسخة الاحتياطية:
   ```bash
   pg_restore -h localhost -U postgres -d pyarchinit_restored backup_pyarchinit.dump
   ```

3. **تحديث** تكوين PyArchInit لاستخدام قاعدة البيانات الجديدة

### استعادة ملفات الوسائط

1. **نسخ** ملفات النسخ الاحتياطي إلى مجلد الوسائط:
   ```bash
   cp -r backup/pyarchinit_media_backup/* ~/pyarchinit/pyarchinit_image_folder/
   ```

---

## النسخ الاحتياطي الكامل للمشروع

### ما يجب تضمينه

| العنصر | المسار |
|--------|--------|
| قاعدة بيانات SQLite | `pyarchinit_DB_folder/pyarchinit_db.sqlite` |
| الوسائط | `pyarchinit_image_folder/` |
| ملفات PDF المُنشأة | `pyarchinit_PDF_folder/` |
| التقارير | `pyarchinit_Report_folder/` |
| التكوين | `pyarchinit_Logo_folder/`، ملفات .txt |

### سكريبت النسخ الاحتياطي الكامل

**Linux/Mac:**
```bash
#!/bin/bash
DATE=$(date +%Y%m%d)
BACKUP_DIR=~/pyarchinit_backup_$DATE
mkdir -p "$BACKUP_DIR"

# قاعدة البيانات
cp ~/pyarchinit/pyarchinit_DB_folder/pyarchinit_db.sqlite "$BACKUP_DIR/"

# الوسائط
cp -r ~/pyarchinit/pyarchinit_image_folder "$BACKUP_DIR/"

# PDF والتقارير
cp -r ~/pyarchinit/pyarchinit_PDF_folder "$BACKUP_DIR/"
cp -r ~/pyarchinit/pyarchinit_Report_folder "$BACKUP_DIR/"

# ضغط
tar -czvf "$BACKUP_DIR.tar.gz" "$BACKUP_DIR"

echo "اكتمل النسخ الاحتياطي الكامل: $BACKUP_DIR.tar.gz"
```

---

## أفضل الممارسات

### تكرار النسخ الاحتياطي

| نوع النشاط | التكرار الموصى به |
|------------|------------------|
| حفر نشط | يومياً |
| ما بعد الحفر | أسبوعياً |
| الأرشفة | قبل كل تعديل مهم |

### الحفظ

- الاحتفاظ بـ **3 نسخ** على الأقل في أماكن مختلفة
- استخدام **التخزين السحابي** للتكرار
- **التحقق دورياً** من سلامة النسخ الاحتياطية

### التسمية

الصيغة الموصى بها:
```
[المشروع]_[النوع]_[التاريخ]_[الإصدار]
مثال: villa_romana_db_20240115_v1.sqlite
```

### التوثيق

إنشاء سجل للنسخ الاحتياطية:
```
التاريخ: 2024-01-15
النوع: نسخ احتياطي كامل
الملف: villa_romana_backup_20240115.tar.gz
الحجم: 2.5 GB
ملاحظات: قبل إغلاق حملة 2024
```

---

## أتمتة النسخ الاحتياطي

### Cron Job (Linux/Mac)

الإضافة إلى crontab (`crontab -e`):
```
# نسخ احتياطي يومي الساعة 23:00
0 23 * * * /path/to/backup_script.sh
```

### مجدول المهام (Windows)

1. فتح **مجدول المهام**
2. إنشاء مهمة أساسية
3. تعيين المشغل (يومي)
4. الإجراء: تشغيل برنامج > سكريبت batch

---

## استكشاف الأخطاء وإصلاحها

### المشكلة: قاعدة البيانات تالفة بعد الاستعادة

**السبب**: ملف النسخ الاحتياطي غير مكتمل أو تالف.

**الحل**:
1. التحقق من السلامة بـ `sqlite3 database.sqlite "PRAGMA integrity_check;"`
2. استخدام نسخة احتياطية سابقة
3. محاولة الاستعادة بأدوات SQLite

### المشكلة: حجم النسخ الاحتياطي مفرط

**السبب**: ملفات وسائط كثيرة أو قاعدة بيانات كبيرة جداً.

**الحل**:
1. ضغط النسخ الاحتياطية
2. تنفيذ VACUUM على قاعدة البيانات
3. أرشفة الوسائط الأقدم بشكل منفصل

### المشكلة: خطأ اتصال pg_dump

**السبب**: معاملات الاتصال خاطئة.

**الحل**:
1. التحقق من المضيف، المنفذ، المستخدم
2. فحص pg_hba.conf للأذونات
3. اختبار الاتصال بـ psql

---

## الترحيل بين قواعد البيانات

### من SQLite إلى PostgreSQL

1. تصدير البيانات من SQLite
2. إنشاء المخطط في PostgreSQL
3. استيراد البيانات

يدير PyArchInit هذا عبر إعدادات التكوين.

### من PostgreSQL إلى SQLite

1. تصدير البيانات من PostgreSQL
2. إنشاء قاعدة بيانات SQLite
3. استيراد البيانات

---

## المراجع

### المسارات القياسية

| النظام | المسار الأساسي |
|--------|----------------|
| Linux/Mac | `~/pyarchinit/` |
| Windows | `C:\Users\[المستخدم]\pyarchinit\` |

### الأدوات المفيدة

- **SQLite Browser**: عرض/تعديل قاعدة بيانات SQLite
- **pgAdmin**: إدارة PostgreSQL
- **7-Zip/tar**: ضغط النسخ الاحتياطية
- **rsync**: المزامنة التزايدية

---

## فيديو تعليمي

### النسخ الاحتياطي وأمان البيانات
**المدة**: 10-12 دقيقة
- إجراءات النسخ الاحتياطي
- استعادة قاعدة البيانات
- الأتمتة

[فيديو مؤقت: video_backup_restore.mp4]

---

*آخر تحديث: يناير 2026*
*PyArchInit - نظام إدارة البيانات الأثرية*
