# الدرس 14: نظم المعلومات الجغرافية والخرائط

## المقدمة

PyArchInit متكامل بعمق مع **QGIS**، مستفيداً من جميع وظائف GIS لإدارة البيانات الأثرية مكانياً. يغطي هذا الدرس التكامل الخرائطي، والطبقات المُعدة مسبقاً، والوظائف المتقدمة مثل **التجزئة التلقائية SAM**.

### وظائف GIS الرئيسية

- عرض الوحدات الطبقية على الخريطة
- طبقات متجهة مُعدة مسبقاً
- تنسيق QML مخصص
- الارتفاعات والقياسات GIS
- التجزئة التلقائية (SAM)
- تصدير الخرائط

## طبقات PyArchInit المُعدة مسبقاً

### الطبقات المتجهة الرئيسية

| الطبقة | الهندسة | الوصف |
|--------|---------|-------|
| `pyunitastratigrafiche` | MultiPolygon | وحدات طبقية ترسب |
| `pyunitastratigrafiche_usm` | MultiPolygon | وحدات طبقية جدارية |
| `pyarchinit_quote` | Point | نقاط الارتفاع |
| `pyarchinit_siti` | Point | مواقع المواقع الأثرية |
| `pyarchinit_ripartizioni_spaziali` | Polygon | مناطق الحفر |
| `pyarchinit_strutture_ipotesi` | Polygon | هياكل مفترضة |
| `pyarchinit_documentazione` | Point | مراجع التوثيق |

### سمات طبقة الوحدات الطبقية

| الحقل | النوع | الوصف |
|-------|-------|-------|
| `gid` | Integer | معرف فريد |
| `scavo_s` | Text | اسم الموقع |
| `area_s` | Text | رقم المنطقة |
| `us_s` | Text | رقم الوحدة الطبقية |
| `stratigraph_index_us` | Integer | الفهرس الطبقي |
| `tipo_us_s` | Text | نوع الوحدة |
| `rilievo_originale` | Text | المرفوع الأصلي |
| `disegnatore` | Text | مؤلف المرفوع |
| `data` | Date | تاريخ المرفوع |

## عرض الوحدات الطبقية على الخريطة

### من تبويب "الخريطة" في بطاقة الوحدة الطبقية

1. فتح بطاقة الوحدة الطبقية
2. اختيار تبويب **الخريطة**
3. الوظائف المتاحة:

| الزر | الوظيفة |
|------|---------|
| عرض الوحدة | عرض الوحدة الحالية على الخريطة |
| عرض الكل | عرض جميع وحدات المنطقة |
| سجل جديد | إنشاء هندسة جديدة |
| توسيط | توسيط الخريطة على الوحدة |

### العرض من البحث

1. تنفيذ بحث عن الوحدات
2. زر **"عرض السجل"** ← يعرض وحدة مفردة
3. زر **"عرض الكل"** ← يعرض جميع النتائج

## تنسيق الطبقات

### ملفات QML

يتضمن PyArchInit أنماطاً مُعدة مسبقاً بصيغة QML:
```
pyarchinit/styles/
├── pyunitastratigrafiche.qml
├── pyunitastratigrafiche_usm.qml
├── pyarchinit_quote.qml
└── ...
```

### تطبيق النمط

1. اختيار الطبقة في المفتاح
2. النقر بالزر الأيمن ← **الخصائص**
3. تبويب **النمط**
4. **تحميل نمط** ← اختيار QML

### التخصيص

يمكن تخصيص الأنماط لـ:
- الألوان حسب نوع الوحدة
- التسميات برقم الوحدة
- الشفافية
- الحدود والتعبئات

## الارتفاعات والقياسات

### طبقة الارتفاعات

تخزن طبقة `pyarchinit_quote`:
- الإحداثيات X، Y
- الارتفاع Z (المطلق)
- نوع نقطة الارتفاع
- الوحدة الطبقية المرجعية
- المنطقة المرجعية

### حساب الارتفاعات التلقائي

من بطاقة الوحدة الطبقية، تُحسب الارتفاعات الدنيا/القصوى:
1. استعلام نقاط الارتفاع المرتبطة بالوحدة
2. استخراج القيمة الدنيا والقصوى
3. العرض في التقرير

### إدخال الارتفاعات

1. طبقة الارتفاعات في وضع التحرير
2. رسم نقطة على الخريطة
3. ملء السمات:
   - `sito_q`
   - `area_q`
   - `us_q`
   - `quota`
   - `unita_misura_q`

## التجزئة التلقائية SAM

### ما هو SAM؟

**SAM (Segment Anything Model)** هو نموذج ذكاء اصطناعي طورته Meta للتجزئة التلقائية للصور. يدمجه PyArchInit لـ:
- الرقمنة التلقائية للحجارة/العناصر
- تجزئة الصور الجوية
- تسريع المرفوع

### الوصول إلى الوظيفة

1. **PyArchInit** ← **تجزئة SAM**
2. أو من شريط الأدوات: أيقونة **SAM**

### واجهة SAM

```
+--------------------------------------------------+
|        تجزئة الحجارة SAM                          |
+--------------------------------------------------+
| المدخلات:                                         |
|   طبقة الراستر: [قائمة منسدلة الصور]              |
+--------------------------------------------------+
| الطبقة الهدف:                                     |
|   [o] pyunitastratigrafiche                      |
|   [ ] pyunitastratigrafiche_usm                  |
+--------------------------------------------------+
| السمات الافتراضية:                                |
|   الموقع: [حقل تلقائي]                           |
|   المنطقة: [إدخال المنطقة]                        |
|   الفهرس الطبقي: [1-10]                          |
|   نوع الوحدة: [حجر|طبقة|تراكم|قطع]               |
+--------------------------------------------------+
| وضع التجزئة:                                      |
|   [o] تلقائي (اكتشاف جميع الحجارة)               |
|   [ ] وضع النقر (نقر على كل حجر)                 |
|   [ ] وضع المربع (رسم مستطيل)                    |
|   [ ] وضع المضلع (رسم حر)                        |
|   [ ] من طبقة (استخدام مضلع موجود)               |
+--------------------------------------------------+
| النموذج:                                          |
|   [قائمة منسدلة النموذج]                          |
|   مفتاح API: [******]                            |
+--------------------------------------------------+
|        [بدء التجزئة]  [إلغاء]                      |
+--------------------------------------------------+
```

### أوضاع التجزئة

#### 1. الوضع التلقائي
- يُجزئ تلقائياً جميع الكائنات المرئية
- مثالي للمناطق ذات الحجارة الكثيرة
- يتطلب صوراً عالية الجودة

#### 2. وضع النقر
- النقر على كل كائن للتجزئة
- نقر يمين أو Enter للإنهاء
- Escape للإلغاء
- أكثر دقة للكائنات المحددة

#### 3. وضع المربع
- رسم مستطيل على المنطقة
- يُجزئ فقط المنطقة المحددة
- مفيد للمناطق المحدودة

#### 4. وضع المضلع
- رسم مضلع حر
- نقر لإضافة رؤوس
- نقر يمين للإكمال
- للمناطق غير المنتظمة

#### 5. وضع من طبقة
- يستخدم مضلعاً موجوداً كقناع
- اختيار طبقة مضلعية
- يُجزئ فقط داخل المضلع

### النماذج المتاحة

| النموذج | النوع | المتطلبات | الجودة |
|---------|-------|-----------|--------|
| Replicate SAM-2 | API سحابي | مفتاح API | ممتازة |
| Roboflow SAM-3 | API سحابي | مفتاح API | ممتازة + موجه نصي |
| SAM vit_b | محلي | 375MB VRAM | جيدة |
| SAM vit_l | محلي | 1.2GB VRAM | جيدة جداً |
| SAM vit_h | محلي | 2.5GB VRAM | ممتازة |
| OpenCV | محلي | لا شيء | أساسية |

### SAM-3 مع الموجه النصي

تدعم نسخة SAM-3 (Roboflow) **الموجهات النصية**:
- "stones" - حجارة
- "pottery fragments" - شظايا فخارية
- "bones" - عظام
- أي وصف نصي

### تكوين API

#### Replicate API (SAM-2)
1. التسجيل على [replicate.com](https://replicate.com)
2. الحصول على مفتاح API
3. إدخاله في الإعدادات

#### Roboflow API (SAM-3)
1. التسجيل على [roboflow.com](https://roboflow.com)
2. الحصول على مفتاح API
3. إدخاله في الإعدادات

### سير عمل SAM

1. **التحضير**
   - تحميل الصورة كطبقة راستر
   - التحقق من النظام المرجعي
   - تحضير الطبقة الهدف

2. **التكوين**
   - اختيار راستر الإدخال
   - تعيين السمات الافتراضية
   - اختيار الوضع والنموذج

3. **التنفيذ**
   - النقر على "بدء التجزئة"
   - انتظار المعالجة
   - التحقق من النتائج

4. **ما بعد المعالجة**
   - التحقق من المضلعات المُنشأة
   - تعيين أرقام الوحدات الطبقية
   - تصحيح الأخطاء المحتملة

## التكامل الخرائطي

### تصدير بيانات GIS

من بطاقة الوحدة الطبقية، تبويب الخريطة:
- **تصدير GeoPackage**: الطبقة كـ GPKG
- **تصدير Shapefile**: الطبقة كـ SHP
- **تصدير GeoJSON**: الطبقة كـ JSON

### استيراد بيانات GIS

استيراد هندسات موجودة:
1. تحميل الطبقة في QGIS
2. اختيار المعالم
3. استخدام وظيفة الاستيراد

### المعالجة الجغرافية

العمليات المكانية المتاحة:
- Buffer
- التقاطع
- الاتحاد
- الفرق
- النقاط المركزية

## أفضل الممارسات

### 1. الصور الجوية

- الدقة الدنيا: 1-2 سم/بكسل
- الصيغة: GeoTIFF مُرجع جغرافياً
- النظام المرجعي: متسق مع المشروع

### 2. الرقمنة

- استخدام المغناطيس للدقة
- التحقق من الطوبولوجيا
- الحفاظ على اتساق السمات

### 3. تجزئة SAM

- صور عالية الجودة
- إضاءة منتظمة
- تباين كافٍ بين الكائنات والخلفية
- التحقق اللاحق ضروري دائماً

### 4. تنظيم الطبقات

- التجميع حسب النوع
- استخدام أنماط متسقة
- الحفاظ على الترتيب في المفتاح

## حل المشكلات

### الطبقات لا تُعرض

**الأسباب المحتملة**:
- نطاق خاطئ
- نظام مرجعي مختلف
- مرشح نشط

**الحلول**:
- تكبير إلى الطبقة
- التحقق من CRS
- إزالة المرشحات

### SAM لا يعمل

**الأسباب المحتملة**:
- مفتاح API غير صالح
- راستر غير مُرجع جغرافياً
- نموذج محلي غير مُثبت

**الحلول**:
- التحقق من مفتاح API
- التحقق من الترجيع الجغرافي
- تثبيت النموذج

### هندسات تالفة

**الأسباب المحتملة**:
- أخطاء رقمنة
- استيراد إشكالي

**الحلول**:
- استخدام "إصلاح الهندسات"
- إعادة رسم العنصر

## المراجع

### الملفات المصدرية
- `modules/gis/pyarchinit_pyqgis.py` - تكامل GIS
- `tabs/Sam_Segmentation_Dialog.py` - حوار SAM
- `modules/gis/sam_map_tools.py` - أداة خريطة SAM

### الطبقات
- `pyunitastratigrafiche` - وحدات ترسب
- `pyunitastratigrafiche_usm` - وحدات جدارية
- `pyarchinit_quote` - ارتفاعات

---

## فيديوهات تعليمية

### تكامل GIS
`[فيديو مؤقت: video_gis_integration.mp4]`

**المحتويات**:
- الطبقات المُعدة مسبقاً
- عرض الوحدات الطبقية
- التنسيق والتسميات
- تصدير الخرائط

**المدة المتوقعة**: 15-18 دقيقة

### تجزئة SAM
`[فيديو مؤقت: video_sam_segmentation.mp4]`

**المحتويات**:
- تكوين SAM
- أوضاع التجزئة
- ما بعد المعالجة
- أفضل الممارسات

**المدة المتوقعة**: 12-15 دقيقة

---

*آخر تحديث: يناير 2026*

---

## رسوم متحركة تفاعلية

استكشف الرسوم المتحركة التفاعلية لمعرفة المزيد حول هذا الموضوع.

[افتح الرسوم المتحركة التفاعلية](../../animations/pyarchinit_image_classification_animation.html)
