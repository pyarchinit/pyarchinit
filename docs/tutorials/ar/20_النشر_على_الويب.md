# الدرس 20: النشر على الويب مع Lizmap

## المقدمة

يدعم PyArchInit **النشر على الويب** للبيانات الأثرية من خلال **Lizmap**، وهو تطبيق يتيح تحويل مشاريع QGIS إلى تطبيقات ويب تفاعلية.

### ما هو Lizmap؟

يتكون Lizmap من:
- **إضافة QGIS**: لتكوين النشر
- **Lizmap Web Client**: تطبيق ويب لعرض الخرائط
- **QGIS Server**: الخلفية لخدمة الخرائط

### مزايا النشر على الويب

| الجانب | الوصف |
|--------|-------|
| إمكانية الوصول | البيانات قابلة للاستشارة من المتصفح |
| المشاركة | توزيع سهل للمعنيين |
| التفاعلية | تكبير، تحريك، استعلام، نوافذ منبثقة |
| التحديث | مزامنة مع قاعدة البيانات |
| المحمول | وصول من الهاتف/الجهاز اللوحي |

## المتطلبات المسبقة

### الخادم

1. **QGIS Server** مُثبت
2. **Lizmap Web Client** مُكون
3. خادم ويب (Apache/Nginx)
4. PHP 7.4+
5. PostgreSQL/PostGIS (موصى به)

### العميل

1. **QGIS Desktop** مع إضافة Lizmap
2. **PyArchInit** مُكون
3. مشروع QGIS محفوظ

## تثبيت إضافة Lizmap

### من QGIS

1. **الإضافات** ← **إدارة الإضافات**
2. البحث عن "Lizmap"
3. تثبيت **Lizmap**
4. إعادة تشغيل QGIS

## تحضير المشروع

### 1. تنظيم الطبقات

البنية الموصى بها:
```
مشروع QGIS
├── مجموعة: الأساس
│   ├── الصور الجوية
│   └── CTR/المساحي
├── مجموعة: الحفر
│   ├── pyunitastratigrafiche
│   ├── pyunitastratigrafiche_usm
│   └── pyarchinit_quote
├── مجموعة: التوثيق
│   ├── صور مُرجعة جغرافياً
│   └── المرفوعات
└── مجموعة: التحليل
    └── مصفوفة هاريس (صورة)
```

### 2. تنسيق الطبقات

لكل طبقة:
1. تطبيق نمط مناسب
2. تكوين التسميات
3. تعيين مقياس الرؤية

### 3. النوافذ المنبثقة والسمات

تكوين النوافذ المنبثقة لكل طبقة:
1. نقر يمين على الطبقة ← **الخصائص**
2. تبويب **العرض**
3. تكوين **HTML Map Tip**

مثال نافذة منبثقة للوحدة الطبقية:
```html
<h3>الوحدة الطبقية [% "us_s" %]</h3>
<p><b>المنطقة:</b> [% "area_s" %]</p>
<p><b>النوع:</b> [% "tipo_us_s" %]</p>
<p><b>التعريف:</b> [% "definizione" %]</p>
```

### 4. حفظ المشروع

1. حفظ المشروع (.qgz) في مجلد Lizmap
2. استخدام مسارات نسبية للبيانات
3. التحقق من إمكانية الوصول لجميع الطبقات

## تكوين Lizmap

### فتح الإضافة

1. **الويب** ← **Lizmap** ← **Lizmap**

### تبويب عام

| الحقل | الوصف | القيمة |
|-------|-------|--------|
| عنوان الخريطة | الاسم المعروض | "حفريات طريق روما" |
| الملخص | الوصف | "التوثيق الأثري..." |
| الصورة | صورة مصغرة للمشروع | project_thumb.png |
| المستودع | مجلد الخادم | /var/www/lizmap/projects |

### تبويب الطبقة

لكل طبقة تكوين:

| الخيار | الوصف |
|--------|-------|
| مُفعل | الطبقة مرئية في Lizmap |
| طبقة أساسية | طبقة الخلفية (صور جوية، إلخ.) |
| نافذة منبثقة | تفعيل النافذة المنبثقة عند النقر |
| التحرير | يسمح بالتعديل عبر الإنترنت |
| المرشح | مرشحات المستخدم |

### تبويب الخريطة الأساسية

تكوين الخلفيات:
- OpenStreetMap
- Google Maps (يتطلب مفتاح API)
- Bing Maps
- صور جوية مخصصة

### تبويب تحديد الموقع

البحث حسب المكان:
- تكوين الطبقة للبحث
- الحقول للبحث
- صيغة العرض

### تبويب التحرير (اختياري)

للسماح بالتحرير عبر الإنترنت:
1. اختيار الطبقات القابلة للتعديل
2. تكوين الحقول القابلة للتحرير
3. تعيين الأذونات

### تبويب الأدوات

تفعيل/إلغاء تفعيل:
- الطباعة
- القياسات
- التحديد
- الرابط الدائم
- إلخ.

### حفظ التكوين

النقر على **حفظ** لتوليد ملف `.qgs.cfg`

## النشر

### الرفع على الخادم

1. نسخ ملفات `.qgz` و `.qgz.cfg` إلى الخادم
2. التحقق من أذونات الملفات
3. تكوين QGIS Server

### بنية الخادم

```
/var/www/lizmap/
├── lizmap/           # تطبيق Lizmap
├── projects/         # مشاريع QGIS
│   ├── scavo_roma.qgz
│   └── scavo_roma.qgz.cfg
└── var/              # بيانات التطبيق
```

### تكوين QGIS Server

ملف `/etc/apache2/sites-available/lizmap.conf`:
```apache
<VirtualHost *:80>
    ServerName lizmap.example.com
    DocumentRoot /var/www/lizmap/lizmap/www

    <Directory /var/www/lizmap/lizmap/www>
        AllowOverride All
        Require all granted
    </Directory>

    # QGIS Server
    ScriptAlias /cgi-bin/ /usr/lib/cgi-bin/
    <Directory "/usr/lib/cgi-bin">
        AllowOverride All
        Require all granted
    </Directory>

    FcgidInitialEnv QGIS_SERVER_LOG_FILE /var/log/qgis/qgis_server.log
    FcgidInitialEnv QGIS_SERVER_LOG_LEVEL 0
</VirtualHost>
```

## الوصول عبر الويب

### عنوان URL للتطبيق

```
http://lizmap.example.com/
```

### التنقل

1. اختيار المشروع من الصفحة الرئيسية
2. عرض الخريطة التفاعلية
3. الأدوات في شريط الأدوات

### وظائف المستخدم

| الوظيفة | الوصف |
|---------|-------|
| التكبير | عجلة الماوس، أزرار +/- |
| التحريك | سحب الخريطة |
| النافذة المنبثقة | النقر على المعلم |
| البحث | شريط البحث |
| الطباعة | تصدير إلى PDF |
| الرابط الدائم | URL قابل للمشاركة |

## تكامل PyArchInit

### البيانات في الوقت الفعلي

مع PostgreSQL:
- البيانات محدثة دائماً
- التعديلات في PyArchInit مرئية فوراً
- لا حاجة لمزامنة يدوية

### الطبقات الموصى بها

| طبقة PyArchInit | النشر |
|-----------------|-------|
| pyunitastratigrafiche | نعم، مع نافذة منبثقة |
| pyunitastratigrafiche_usm | نعم، مع نافذة منبثقة |
| pyarchinit_quote | نعم |
| pyarchinit_siti | نعم، كنظرة عامة |
| مصفوفة هاريس | كصورة ثابتة |

### تكوين النافذة المنبثقة للوحدة الطبقية

قالب HTML متقدم:
```html
<div class="us-popup">
    <h3 style="color:#2c3e50;">الوحدة الطبقية [% "us_s" %]</h3>
    <table>
        <tr><td><b>الموقع:</b></td><td>[% "scavo_s" %]</td></tr>
        <tr><td><b>المنطقة:</b></td><td>[% "area_s" %]</td></tr>
        <tr><td><b>النوع:</b></td><td>[% "tipo_us_s" %]</td></tr>
        <tr><td><b>التعريف:</b></td><td>[% "definizione" %]</td></tr>
        <tr><td><b>الفترة:</b></td><td>[% "periodo" %]</td></tr>
    </table>
    [% if "foto_url" %]
    <img src="[% "foto_url" %]" style="max-width:200px;"/>
    [% end %]
</div>
```

## الأمان

### المصادقة

يدعم Lizmap:
- مستخدمين محليين
- LDAP
- OAuth2

### تكوين المستخدمين

في إدارة Lizmap:
1. إنشاء مجموعات (مسؤول، عالم آثار، عام)
2. إنشاء مستخدمين
3. تعيين الأذونات لكل مشروع

### أذونات الطبقة

| المجموعة | العرض | التحرير | الطباعة |
|----------|-------|---------|---------|
| مسؤول | الكل | الكل | نعم |
| عالم آثار | الكل | بعض | نعم |
| عام | الأساسية فقط | لا | لا |

## الصيانة

### تحديث المشاريع

1. تعديل المشروع في QGIS Desktop
2. إعادة توليد تكوين Lizmap
3. الرفع على الخادم

### ذاكرة التخزين المؤقت

إدارة ذاكرة التخزين المؤقت للبلاط:
```bash
# مسح ذاكرة التخزين المؤقت
lizmap-cache-clearer.php -project scavo_roma

# إعادة توليد البلاط
lizmap-tiles-seeder.php -project scavo_roma -bbox xmin,ymin,xmax,ymax
```

### السجل والتصحيح

```bash
# سجل QGIS Server
tail -f /var/log/qgis/qgis_server.log

# سجل Lizmap
tail -f /var/www/lizmap/var/log/messages.log
```

## أفضل الممارسات

### 1. تحسين الأداء

- استخدام طبقات راستر مُبلطة مسبقاً
- تحديد عدد المعالم لكل طبقة
- تكوين مقاييس الرؤية
- استخدام الفهارس المكانية

### 2. تجربة المستخدم

- نوافذ منبثقة مفيدة ولكن موجزة
- أنماط واضحة ومقروءة
- تنظيم منطقي للطبقات
- توثيق للمستخدمين

### 3. الأمان

- HTTPS إلزامي
- تحديثات منتظمة
- نسخ احتياطي للتكوينات
- مراقبة الوصول

### 4. النسخ الاحتياطي

- نسخ احتياطي لملفات `.qgz` و `.cfg`
- نسخ احتياطي لقاعدة بيانات PostgreSQL
- إصدارات التكوينات

## حل المشكلات

### الخريطة لا تُعرض

**الأسباب**:
- QGIS Server غير مُكون
- مسارات الملفات خاطئة
- أذونات غير كافية

**الحلول**:
- التحقق من سجل QGIS Server
- فحص المسارات في المشروع
- التحقق من أذونات الملفات

### النوافذ المنبثقة لا تعمل

**الأسباب**:
- الطبقة غير مُكونة للنوافذ المنبثقة
- HTML خاطئ في القالب

**الحلول**:
- تفعيل النوافذ المنبثقة في Lizmap
- التحقق من صيغة HTML

### الأداء بطيء

**الأسباب**:
- بيانات كثيرة جداً
- ذاكرة التخزين المؤقت غير مُكونة
- الخادم ناقص الموارد

**الحلول**:
- تقليل البيانات المرئية
- تكوين ذاكرة التخزين المؤقت للبلاط
- زيادة موارد الخادم

## المراجع

### البرامج
- [Lizmap](https://www.lizmap.com/)
- [QGIS Server](https://docs.qgis.org/latest/en/docs/server_manual/)

### التوثيق
- [Lizmap Documentation](https://docs.lizmap.com/)
- [QGIS Server Documentation](https://docs.qgis.org/latest/en/docs/server_manual/)

---

## فيديوهات تعليمية

### إعداد Lizmap
`[فيديو مؤقت: video_lizmap_setup.mp4]`

**المحتويات**:
- تثبيت الإضافة
- تكوين المشروع
- النشر

**المدة المتوقعة**: 20-25 دقيقة

### تخصيص الويب
`[فيديو مؤقت: video_lizmap_custom.mp4]`

**المحتويات**:
- نوافذ منبثقة متقدمة
- أنماط مخصصة
- إدارة المستخدمين

**المدة المتوقعة**: 15-18 دقيقة

---

*آخر تحديث: يناير 2026*
