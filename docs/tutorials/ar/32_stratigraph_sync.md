# PyArchInit - StratiGraph: لوحة المزامنة

## الفهرس
1. [مقدمة](#مقدمة)
2. [الوصول إلى اللوحة](#الوصول-إلى-اللوحة)
3. [فهم الواجهة](#فهم-الواجهة)
4. [تصدير الحزم](#تصدير-الحزم)
5. [المزامنة](#المزامنة)
6. [إدارة قائمة الانتظار](#إدارة-قائمة-الانتظار)
7. [الإعدادات](#الإعدادات)
8. [استكشاف الأخطاء وإصلاحها](#استكشاف-الأخطاء-وإصلاحها)
9. [الأسئلة الشائعة](#الأسئلة-الشائعة)

---

## مقدمة

بدءاً من الإصدار **5.0.2-alpha**، يتضمن PyArchInit لوحة **StratiGraph Sync** التي تتيح مزامنة البيانات بنمط العمل دون اتصال أولاً (offline-first) مع رسم المعرفة (Knowledge Graph) الخاص بـ StratiGraph. هذه اللوحة جزء من مشروع **StratiGraph** الأوروبي (Horizon Europe) وتنفذ سير العمل دون اتصال أولاً: تعمل محلياً بدون إنترنت، وتصدر الحزم عندما تكون جاهزاً، ويقوم النظام بالمزامنة تلقائياً عند استعادة الاتصال.

<!-- VIDEO: مقدمة عن StratiGraph Sync -->
> **فيديو تعليمي**: [أدخل رابط فيديو مقدمة StratiGraph Sync]

### نظرة عامة على سير العمل

```
1. العمل دون اتصال     2. تصدير حزمة          3. مزامنة تلقائية
   (OFFLINE_EDITING)       (LOCAL_EXPORT)        (QUEUED_FOR_SYNC)
        |                      |                      |
   إدخال البيانات        تصدير + تحقق          رفع عند الاتصال
   بشكل طبيعي في         + وضع في قائمة         مع إعادة المحاولة
   PyArchInit             الانتظار               تلقائياً
```

---

## الوصول إلى اللوحة

لوحة StratiGraph Sync مخفية افتراضياً ويمكن تفعيلها عبر زر في شريط الأدوات.

### من شريط الأدوات

1. ابحث عن زر **StratiGraph Sync** في شريط أدوات PyArchInit -- له أيقونة خضراء مع أسهم مزامنة والحرف "S"
2. انقر على الزر **لإظهار** اللوحة (زر تبديل)
3. انقر مرة أخرى **لإخفاء** اللوحة

تظهر اللوحة كـ **أداة رصيف على اليسار** في واجهة QGIS. يمكنك سحبها وإعادة وضعها كأي لوحة رصيف أخرى في QGIS.

<!-- IMAGE: زر شريط الأدوات لـ StratiGraph Sync -->
> **شكل 1**: زر StratiGraph Sync في شريط الأدوات (أيقونة خضراء مع أسهم مزامنة و"S")

<!-- IMAGE: اللوحة مثبتة على الجانب الأيسر من QGIS -->
> **شكل 2**: لوحة StratiGraph Sync مثبتة على الجانب الأيسر من نافذة QGIS

---

## فهم الواجهة

تنقسم لوحة StratiGraph Sync إلى عدة أقسام، من الأعلى إلى الأسفل.

### مؤشر الحالة

يعرض **مؤشر الحالة** في أعلى اللوحة حالة المزامنة الحالية لبياناتك. الحالات الممكنة هي:

| الحالة | الأيقونة | الوصف |
|--------|----------|-------|
| **OFFLINE_EDITING** | قلم | تعمل محلياً وتحرر البيانات بشكل طبيعي |
| **LOCAL_EXPORT** | حزمة | يتم تصدير حزمة من البيانات المحلية |
| **LOCAL_VALIDATION** | علامة صح | يتم التحقق من الحزمة المصدرة |
| **QUEUED_FOR_SYNC** | ساعة | تم التحقق من الحزمة وهي بانتظار الرفع |
| **SYNC_SUCCESS** | دائرة خضراء | اكتملت آخر مزامنة بنجاح |
| **SYNC_FAILED** | دائرة حمراء | فشلت آخر محاولة مزامنة |

### مؤشر الاتصال

أسفل مؤشر الحالة، يُظهر **مؤشر الاتصال** ما إذا كان النظام يمكنه الوصول إلى خادم StratiGraph:

| الحالة | المعنى |
|--------|--------|
| **متصل (Online)** | نقطة فحص الصحة قابلة للوصول؛ المزامنة التلقائية نشطة |
| **غير متصل (Offline)** | نقطة فحص الصحة غير قابلة للوصول؛ سيتم وضع الحزم في قائمة الانتظار |

يتحقق النظام تلقائياً من الاتصال كل **30 ثانية** (قابل للتعديل).

### عداد قائمة الانتظار

يعرض **عداد قائمة الانتظار** رقمين:

- **الحزم المعلقة**: عدد الحزم التي تنتظر الرفع
- **الحزم الفاشلة**: عدد الحزم التي فشل رفعها (ستتم إعادة المحاولة تلقائياً)

### آخر مزامنة

يعرض **الطابع الزمني** و**النتيجة** (نجاح أو فشل) لآخر محاولة مزامنة.

### أزرار الإجراءات

| الزر | الإجراء |
|------|---------|
| **Export Bundle** | ينشئ حزمة من بياناتك المحلية، يتحقق منها ويضيفها إلى قائمة المزامنة |
| **Sync Now** | يفرض محاولة مزامنة فورية (متاح فقط عند الاتصال) |
| **Queue...** | يفتح نافذة إدارة قائمة الانتظار التي تعرض جميع العناصر |

### سجل النشاط

في أسفل اللوحة، يعرض **سجل نشاط** قابل للتمرير إدخالات مختومة بالوقت للنشاط الأخير، بما في ذلك تغييرات الحالة والصادرات والتحققات ومحاولات المزامنة.

<!-- IMAGE: اللوحة الكاملة مع جميع الأقسام الموضحة -->
> **شكل 3**: لوحة StratiGraph Sync الكاملة مع جميع الأقسام المسمّاة

---

## تصدير الحزم

يقوم تصدير الحزمة بتعبئة بياناتك الأثرية المحلية في تنسيق منظم جاهز للرفع إلى رسم المعرفة الخاص بـ StratiGraph.

### الإجراء خطوة بخطوة

1. تأكد من حفظ جميع أعمالك الحالية في PyArchInit
2. افتح لوحة StratiGraph Sync (إذا لم تكن مرئية بالفعل)
3. انقر على زر **Export Bundle**
4. يقوم النظام تلقائياً بثلاث عمليات:
   - **التصدير**: يتم تعبئة البيانات المحلية في ملف حزمة
   - **التحقق**: يتم فحص الحزمة للاكتمال وسلامة البيانات
   - **الإضافة لقائمة الانتظار**: يتم إضافة الحزمة المتحقق منها إلى قائمة المزامنة
5. راقب **مؤشر الحالة** الذي يمر عبر: `LOCAL_EXPORT` -> `LOCAL_VALIDATION` -> `QUEUED_FOR_SYNC`
6. يسجل **سجل النشاط** كل خطوة مع طابع زمني

### ما تحتويه الحزمة

تحتوي الحزمة على جميع الكيانات الأثرية التي لديها UUID (انظر الدرس 31 لتفاصيل UUID). يتم تعريف كل كيان بواسطة `entity_uuid` الخاص به، مما يضمن التعرف على نفس السجل دائماً على الخادم.

<!-- IMAGE: زر Export Bundle وانتقال الحالة -->
> **شكل 4**: النقر على "Export Bundle" ومراقبة تغييرات الحالة في اللوحة

---

## المزامنة

### المزامنة التلقائية

عندما يكتشف النظام أنك **متصل بالإنترنت** (نجاح فحص الصحة)، يقوم تلقائياً برفع جميع الحزم المعلقة من قائمة الانتظار. لا يلزم أي تدخل يدوي.

عملية المزامنة التلقائية:

1. ينجح فحص الاتصال (نقطة فحص الصحة تستجيب)
2. ينتقل مؤشر الاتصال إلى **متصل (Online)**
3. يتم رفع الحزم المعلقة في قائمة الانتظار واحدة تلو الأخرى
4. يتم وضع علامة `SYNC_SUCCESS` على الحزم المرفوعة بنجاح
5. يتم تحديث الطابع الزمني ونتيجة **آخر مزامنة**

### المزامنة اليدوية

إذا كنت تريد فرض محاولة مزامنة فورية:

1. تأكد من أن مؤشر الاتصال يُظهر **متصل (Online)**
2. انقر على زر **Sync Now**
3. يحاول النظام فوراً رفع جميع الحزم المعلقة

زر **Sync Now** فعّال فقط عندما يكون النظام متصلاً بالإنترنت.

### إعادة المحاولة التلقائية مع تأخير تصاعدي

إذا فشل الرفع، فإن النظام **لا يستسلم**. بدلاً من ذلك، يعيد المحاولة تلقائياً بفترات تأخير متزايدة:

| المحاولة | التأخير |
|----------|---------|
| إعادة المحاولة الأولى | 30 ثانية |
| إعادة المحاولة الثانية | 60 ثانية |
| إعادة المحاولة الثالثة | 120 ثانية |
| إعادة المحاولة الرابعة | 5 دقائق |
| إعادة المحاولة الخامسة | 15 دقيقة |

هذا يمنع إثقال الخادم عندما يكون غير متاح مؤقتاً مع ضمان التسليم النهائي.

<!-- IMAGE: زر Sync Now ومؤشر الاتصال -->
> **شكل 5**: زر "Sync Now" ومؤشر حالة الاتصال

---

## إدارة قائمة الانتظار

يفتح زر **Queue...** نافذة حوار مفصلة حيث يمكنك فحص جميع الحزم في قائمة المزامنة.

### أعمدة نافذة قائمة الانتظار

| العمود | الوصف |
|--------|-------|
| **ID** | المعرف الفريد لعنصر قائمة الانتظار |
| **Status** | الحالة الحالية للعنصر (pending، syncing، success، failed) |
| **Attempts** | عدد محاولات الرفع التي تمت حتى الآن |
| **Created** | الطابع الزمني لإضافة الحزمة إلى قائمة الانتظار |
| **Last Error** | رسالة الخطأ من آخر محاولة فاشلة (فارغ إذا لم يكن هناك خطأ) |
| **Bundle path** | مسار ملف الحزمة في نظام الملفات |

### تفسير عناصر قائمة الانتظار

- عناصر **Pending** في انتظار الرفع
- عناصر **Success** تم رفعها وتأكيدها من الخادم
- عناصر **Failed** ستتم إعادة محاولتها تلقائياً؛ تحقق من عمود **Last Error** للتفاصيل
- عدد **Attempts** يساعدك على فهم عدد المرات التي حاول فيها النظام رفع حزمة معينة

### تخزين قائمة الانتظار

يتم تخزين قاعدة بيانات قائمة الانتظار كملف SQLite في:

```
$PYARCHINIT_HOME/stratigraph_sync_queue.sqlite
```

هذا الملف يستمر بين جلسات QGIS، لذا لن تُفقد الحزم المعلقة إذا أغلقت QGIS.

<!-- IMAGE: نافذة قائمة الانتظار تظهر عدة عناصر -->
> **شكل 6**: نافذة إدارة قائمة الانتظار مع عناصر الحزم

---

## الإعدادات

### عنوان URL لفحص الصحة

يستخدم النظام عنوان URL لفحص الصحة لتحديد الاتصال بخادم StratiGraph. يمكنك تعديله في إعدادات QGIS:

| الإعداد | المفتاح | الافتراضي |
|---------|---------|-----------|
| عنوان URL لفحص الصحة | `pyArchInit/stratigraph/health_check_url` | `http://localhost:8080/health` |

لتغيير عنوان URL لفحص الصحة:

1. افتح **QGIS** -> **الإعدادات** -> **الخيارات** (أو استخدم وحدة تحكم Python في QGIS)
2. انتقل إلى إعدادات PyArchInit أو عيّن عبر:

```python
from qgis.core import QgsSettings
s = QgsSettings()
s.setValue("pyArchInit/stratigraph/health_check_url", "https://your-server.example.com/health")
```

### فترة الفحص

فترة فحص الاتصال الافتراضية هي **30 ثانية**. يمكن أيضاً تعديلها عبر QgsSettings.

---

## استكشاف الأخطاء وإصلاحها

### اللوحة لا تظهر

- تأكد من استخدام PyArchInit الإصدار **5.0.2-alpha** أو أحدث
- تحقق من أن زر StratiGraph Sync مرئي في شريط الأدوات
- حاول إلغاء تفعيل الزر وإعادة تفعيله
- تحقق من **عرض** -> **اللوحات** في QGIS لمعرفة ما إذا كانت أداة الرصيف مدرجة

### مؤشر الاتصال يُظهر دائماً "غير متصل"

- تحقق من أن خادم StratiGraph يعمل ويمكن الوصول إليه
- تحقق من عنوان URL لفحص الصحة في الإعدادات (الافتراضي: `http://localhost:8080/health`)
- اختبر العنوان يدوياً في المتصفح أو باستخدام `curl`:

```bash
curl http://localhost:8080/health
```

- إذا كان الخادم على جهاز آخر، تأكد من عدم وجود قواعد جدار حماية تمنع الاتصال

### فشل تصدير الحزمة

- تأكد من أن قاعدة البيانات متصلة ويمكن الوصول إليها
- تحقق من أن سجلاتك تحتوي على UUID صالحة (الدرس 31)
- راجع سجل النشاط لرسائل الخطأ المحددة
- تأكد من وجود مساحة كافية على القرص لملف الحزمة

### فشل المزامنة بشكل متكرر

- تحقق من عمود **Last Error** في نافذة قائمة الانتظار للتفاصيل
- الأسباب الشائعة:
  - الخادم غير متاح مؤقتاً (سيعيد النظام المحاولة تلقائياً)
  - مشاكل في اتصال الشبكة
  - رفض الخادم الحزمة (تحقق من سجلات الخادم)
- إذا فشلت حزمة باستمرار بعد محاولات عديدة، فكّر في إعادة تصديرها

### مشاكل في قاعدة بيانات قائمة الانتظار

- قاعدة بيانات قائمة الانتظار موجودة في `$PYARCHINIT_HOME/stratigraph_sync_queue.sqlite`
- إذا كانت تالفة، يمكنك حذفها بأمان -- ستُفقد الحزم المعلقة، لكن يمكن إعادة تصديرها
- انسخ هذا الملف احتياطياً إذا كنت بحاجة للحفاظ على حالة قائمة الانتظار

---

## الأسئلة الشائعة

### هل أحتاج إلى إنترنت لاستخدام PyArchInit؟

**لا.** يعمل PyArchInit بالكامل دون اتصال. لوحة StratiGraph Sync تدير فقط المزامنة مع خادم StratiGraph. يمكنك العمل بالكامل دون اتصال والتصدير/المزامنة عندما تكون جاهزاً.

### ماذا يحدث إذا أغلقت QGIS مع وجود حزم معلقة؟

يتم حفظ الحزم المعلقة في قاعدة بيانات قائمة الانتظار وستكون متاحة عند إعادة تشغيل QGIS. يستأنف النظام المزامنة تلقائياً عند استعادة الاتصال.

### هل يمكنني تصدير حزم متعددة؟

نعم. في كل مرة تنقر على "Export Bundle"، يتم إنشاء حزمة جديدة وإضافتها إلى قائمة الانتظار. يمكن وضع حزم متعددة في قائمة الانتظار وسيتم رفعها بالتسلسل.

### كيف أعرف إذا تمت مزامنة بياناتي؟

تحقق من مؤشر **آخر مزامنة** في اللوحة لآخر نتيجة. يمكنك أيضاً فتح نافذة **Queue...** لرؤية حالة كل حزمة على حدة.

### هل يعمل StratiGraph Sync مع PostgreSQL و SQLite؟

نعم. يعمل نظام المزامنة مع كلا نظامي قواعد البيانات المدعومين من PyArchInit. يتم تصدير الحزم بتنسيق مستقل عن قاعدة البيانات.

### ما العلاقة بين UUID والمزامنة؟

توفر UUID (الدرس 31) المعرفات المستقرة التي تجعل المزامنة ممكنة. يتم تعريف كل كيان في الحزمة بواسطة UUID الخاص به، مما يسمح للخادم بمطابقة السجلات أو إنشائها أو تحديثها بشكل صحيح.

---

*وثائق PyArchInit - StratiGraph Sync*
*الإصدار: 5.0.2-alpha*
*آخر تحديث: فبراير 2026*

---

## رسوم متحركة تفاعلية

استكشف الرسوم المتحركة التفاعلية لمعرفة المزيد حول هذا الموضوع.

[افتح الرسوم المتحركة التفاعلية](../../animations/stratigraph_sync_animation.html)
